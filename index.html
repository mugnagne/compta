<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compta Neuille - V20 SIG UPDATE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,400;1,700&family=Roboto+Mono:wght@400;700&family=Inter:wght@400;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Gloria+Hallelujah&display=swap" rel="stylesheet">

    <style>
        :root {
            --neon-yellow: #ccff00;
            --dark: #1a1a1a;
            --paper: #ffffff;
            --soft-grid: #e5e7eb;
            --ledger-line: #bfdbfe;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: var(--dark);
            background-image: linear-gradient(var(--soft-grid) 1px, transparent 1px),
            linear-gradient(90deg, var(--soft-grid) 1px, transparent 1px);
            background-size: 20px 20px;
            padding-bottom: 140px; 
        }

        .font-serif-header { font-family: 'Playfair Display', serif; }
        .font-mono-code { font-family: 'Roboto Mono', monospace; }
        .font-hand { font-family: 'Gloria Hallelujah', cursive; }

        /* SKETCHY UI */
        .sketchy-card {
            background: var(--paper);
            border: 2px solid var(--dark);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            box-shadow: 2px 2px 0px 0px rgba(0,0,0,0.8);
            transition: all 0.2s ease;
            color: var(--dark);
            position: relative;
        }
        .sketchy-card:hover {
            transform: translateY(-2px) rotate(1deg);
            box-shadow: 4px 4px 0px 0px var(--neon-yellow);
            z-index: 50;
        }

        /* SIG DIAGRAM STYLES */
        .sig-box {
            background: white;
            border: 3px solid var(--dark);
            padding: 1rem;
            text-align: center;
            font-weight: bold;
            border-radius: 10px;
            position: relative;
            transition: all 0.2s;
            cursor: default;
        }
        .sig-box.has-info { cursor: pointer; }
        .sig-box.has-info:hover {
            background-color: var(--neon-yellow);
            box-shadow: 4px 4px 0px 0px var(--dark);
            transform: scale(1.02);
        }
        .sig-comment {
            display: none;
            border: 2px dashed var(--dark);
            background: #fffbeb;
            padding: 10px;
            font-size: 0.85rem;
            margin-top: 10px;
            text-align: left;
            font-weight: normal;
            border-radius: 5px;
        }
        .arrow-down {
            width: 2px;
            height: 20px;
            background: var(--dark);
            margin: 0 auto;
        }

        /* INPUTS & ZONES */
        .drop-zone {
            transition: background-color 0.3s, border-color 0.3s;
            border: 2px dashed #9ca3af;
            background-color: rgba(255, 255, 255, 0.4);
            position: relative; display: flex; flex-direction: column;
        }
        .drop-zone:hover { border-color: var(--dark); background-color: rgba(255, 255, 255, 0.9); }
        .block-header { background: var(--dark); color: #fff; padding: 4px 8px; font-family: 'Roboto Mono', monospace; font-size: 0.75rem; text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; }
        .zone-total { margin-top: auto; border-top: 2px dotted var(--dark); padding-top: 4px; text-align: right; font-family: 'Roboto Mono', monospace; font-weight: bold; font-size: 0.8rem; color: var(--dark); }
        .journal-paper { background-color: #fefce8; background-image: repeating-linear-gradient(var(--ledger-line) 0 1px, transparent 1px 100%); background-size: 100% 2rem; line-height: 2rem; box-shadow: 5px 5px 15px rgba(0,0,0,0.1); border-left: 4px double #ef4444; }
        .hardcore-input { border: none; border-bottom: 2px solid var(--dark); background: #f3f4f6; text-align: right; font-family: 'Roboto Mono', monospace; width: 80px; font-weight: bold; color: #2563eb; }
        .hardcore-input:focus { outline: none; background: #e0f2fe; border-color: #2563eb; }
        
        .diff-btn { transition: all 0.2s; }
        .diff-btn.active { background-color: var(--neon-yellow); color: var(--dark); font-weight: 800; box-shadow: inset 2px 2px 0px rgba(0,0,0,0.1); }
        .pixelated-img { image-rendering: pixelated; }
        .valid-success { background-color: #d9f99d !important; border-color: #365314; }
        .valid-error { background-color: #fca5a5 !important; border-color: #7f1d1d; }
        .dragging { opacity: 0.4; transform: scale(0.9); }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes pop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .sig-panel { background: var(--dark); color: #fff; border-top: 4px solid var(--neon-yellow); box-shadow: 0 -10px 30px rgba(0,0,0,0.3); z-index: 50; }
        .nav-tab { cursor: pointer; padding: 10px 20px; font-weight: bold; font-family: 'Roboto Mono'; border-top-left-radius: 8px; border-top-right-radius: 8px; border: 2px solid transparent; border-bottom: none; opacity: 0.6; }
        .nav-tab.active { background: #f3f4f6; border-color: var(--dark); border-bottom: 2px solid #f3f4f6; opacity: 1; color: var(--dark); transform: translateY(2px); }
        .nav-tab:hover:not(.active) { opacity: 1; background: rgba(255,255,255,0.5); }
    </style>
</head>
<body class="selection:bg-[#ccff00] min-h-screen relative">

    <div id="victory-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-[100] backdrop-blur-sm">
        <div class="bg-white border-4 border-gray-900 p-8 relative max-w-md w-full text-center shadow-[10px_10px_0px_0px_#dc2626] animate-pop" style="border-radius: 5px 25px 5px 25px;">
            <button onclick="closeModal()" class="absolute top-2 right-4 text-3xl font-bold text-gray-400 hover:text-gray-900 transition-colors cursor-pointer">&times;</button>
            <div class="relative z-10" id="victory-content"></div>
        </div>
    </div>

    <div class="max-w-[1800px] mx-auto p-4 md:p-6">
        
        <header class="mb-2 flex flex-col xl:flex-row justify-between items-end border-b-4 border-gray-900 pb-4 border-double gap-4">
            <div>
                <div class="flex items-center gap-3">
                    <h1 class="text-3xl md:text-4xl font-extrabold tracking-tighter uppercase italic transform -rotate-1">
                        Compta<span class="text-[#ccff00] bg-gray-900 px-2">Neuille</span>
                    </h1>
                    <span class="bg-gray-200 text-xs px-2 py-1 font-mono-code rounded border border-gray-400">V20 SIG</span>
                </div>
                <h2 id="company-name" class="mt-2 text-xl font-serif-header font-bold text-gray-800 border-b-2 border-[#ccff00] inline-block">Chargement...</h2>
            </div>
        </header>

        <div class="flex border-b-2 border-gray-900 mb-6">
            <div id="tab-1" onclick="switchChapter(1)" class="nav-tab active">CHAP 1 : BILAN & CDR</div>
            <div id="tab-2" onclick="switchChapter(2)" class="nav-tab">CHAP 2 : LES S.I.G</div>
        </div>

        <div id="chapter-1" class="block">
            <div class="flex flex-wrap gap-6 mb-6 items-center">
                <div id="duration-control" class="flex flex-col items-start gap-1 hidden">
                    <label class="text-xs font-bold font-mono-code uppercase text-gray-500">Dur√©e</label>
                    <div class="flex items-center gap-2">
                        <span class="text-xs">Court</span><input type="range" id="game-duration" min="1" max="3" step="1" value="1" class="w-24 h-2 bg-gray-200 rounded-lg cursor-pointer border border-gray-900"><span class="text-xs">Long</span>
                    </div>
                </div>
                <div class="flex items-center gap-1 bg-white border-2 border-gray-900 p-1 shadow-sm rounded-full">
                    <button onclick="setDifficulty('EASY')" id="btn-easy" class="diff-btn active px-3 py-1 font-mono-code text-xs font-bold rounded-sm">EASY</button>
                    <button onclick="setDifficulty('NORMAL')" id="btn-normal" class="diff-btn px-3 py-1 font-mono-code text-xs font-bold rounded-sm hover:bg-gray-100">NORMAL</button>
                    <button onclick="setDifficulty('HARDCORE')" id="btn-hardcore" class="diff-btn px-3 py-1 font-mono-code text-xs font-bold rounded-sm hover:bg-gray-100 text-red-600">HARDCORE üî•</button>
                </div>
                <button onclick="initGame()" class="px-4 py-2 bg-white border-2 border-gray-900 shadow-[3px_3px_0px_0px_#ccff00] hover:shadow-none font-bold font-mono-code uppercase text-xs cursor-pointer">‚ö° Reset</button>
            </div>

            <div class="grid grid-cols-12 gap-6">
                <div class="col-span-12 lg:col-span-3 flex flex-col gap-6">
                    <div id="journal-panel" class="hidden">
                        <div class="journal-paper p-4 border border-gray-300 min-h-[400px] max-h-[600px] overflow-y-auto shadow-xl relative transform -rotate-1">
                            <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-3 py-1 text-sm font-bold font-mono-code rotate-1">JOURNAL DES OP√âRATIONS</div>
                            <div id="journal-content" class="font-hand text-gray-800 text-sm pt-4 space-y-4"></div>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-3 border-2 border-gray-900 rounded-lg relative shadow-xl">
                        <h3 class="text-neon-yellow font-bold mb-4 font-mono-code uppercase text-xs tracking-widest border-b border-gray-600 pb-2">Comptes √† classer</h3>
                        <div id="source-zone" class="space-y-2 min-h-[200px]" ondrop="drop(event)" ondragover="allowDrop(event)" data-type="TODO"></div>
                    </div>
                </div>

                <div class="col-span-12 lg:col-span-9 flex flex-col gap-10">
                    <div>
                        <h3 class="font-black text-2xl italic uppercase border-l-8 border-[#ccff00] pl-3 mb-4">I. Compte de R√©sultat</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="ledger-container">
                                <div class="bg-gray-200 p-2 font-bold text-center border-b-2 border-gray-900 flex justify-between items-center"><span>CHARGES (D√©bit)</span><span class="text-xs bg-gray-900 text-white px-2 rounded">Cl. 6</span></div>
                                <div class="p-3 space-y-3">
                                    <div class="drop-zone p-2 rounded min-h-[80px]" ondrop="drop(event)" ondragover="allowDrop(event)" data-type="CHARGE" data-subtype="EXPLOIT">
                                        <div class="block-header"><span>Exploitation</span><span class="text-[0.6rem] opacity-70">60-65+68</span></div><div id="zone-charge-exploit" class="min-h-[40px] space-y-1 mt-2"></div><div class="zone-total" id="total-charge-exploit">0 ‚Ç¨</div>
                                    </div>
                                    <div class="drop-zone p-2 rounded min-h-[80px]" ondrop="drop(event)" ondragover="allowDrop(event)" data-type="CHARGE" data-subtype="FINANCE">
                                        <div class="block-header"><span>Financi√®res</span><span class="text-[0.6rem] opacity-70">66</span></div><div id="zone-charge-finance" class="min-h-[40px] space-y-1 mt-2"></div><div class="zone-total" id="total-charge-finance">0 ‚Ç¨</div>
                                    </div>
                                    <div class="drop-zone p-2 rounded min-h-[80px]" ondrop="drop(event)" ondragover="allowDrop(event)" data-type="CHARGE" data-subtype="EXCEP">
                                        <div class="block-header"><span>Exceptionnelles</span><span class="text-[0.6rem] opacity-70">67</span></div><div id="zone-charge-excep" class="min-h-[40px] space-y-1 mt-2"></div><div class="zone-total" id="total-charge-excep">0 ‚Ç¨</div>
                                    </div>
                                </div>
                            </div>
                            <div class="ledger-container">
                                <div class="bg-gray-200 p-2 font-bold text-center border-b-2 border-gray-900 flex justify-between items-center"><span>PRODUITS (Cr√©dit)</span><span class="text-xs bg-gray-900 text-white px-2 rounded">Cl. 7</span></div>
                                <div class="p-3 space-y-3">
                                    <div class="drop-zone p-2 rounded min-h-[80px]" ondrop="drop(event)" ondragover="allowDrop(event)" data-type="PRODUIT" data-subtype="EXPLOIT">
                                        <div class="block-header"><span>Exploitation</span><span class="text-[0.6rem] opacity-70">70-75</span></div><div id="zone-produit-exploit" class="min-h-[40px] space-y-1 mt-2"></div><div class="zone-total" id="total-produit-exploit">0 ‚Ç¨</div>
                                    </div>
                                    <div class="drop-zone p-2 rounded min-h-[80px]" ondrop="drop(event)" ondragover="allowDrop(event)" data-type="PRODUIT" data-subtype="FINANCE">
                                        <div class="block-header"><span>Financiers</span><span class="text-[0.6rem] opacity-70">76</span></div><div id="zone-produit-finance" class="min-h-[40px] space-y-1 mt-2"></div><div class="zone-total" id="total-produit-finance">0 ‚Ç¨</div>
                                    </div>
                                    <div class="drop-zone p-2 rounded min-h-[80px]" ondrop="drop(event)" ondragover="allowDrop(event)" data-type="PRODUIT" data-subtype="EXCEP">
                                        <div class="block-header"><span>Exceptionnels</span><span class="text-[0.6rem] opacity-70">77</span></div><div id="zone-produit-excep" class="min-h-[40px] space-y-1 mt-2"></div><div class="zone-total" id="total-produit-excep">0 ‚Ç¨</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-black text-2xl italic uppercase border-l-8 border-blue-500 pl-3 mb-4">II. Bilan (Patrimoine)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="ledger-container border-blue-900">
                                <div class="bg-blue-100 p-2 font-bold text-center border-b-2 border-blue-900 text-blue-900">ACTIF (Emplois)</div>
                                <div class="p-3 space-y-3">
                                    <div class="drop-zone p-2 rounded min-h-[100px]" ondrop="drop(event)" ondragover="allowDrop(event)" data-type="ACTIF" data-subtype="IMMO">
                                        <div class="block-header bg-blue-900"><span>Actif Immobilis√©</span><span class="text-[0.6rem] opacity-70">Cl. 2</span></div><div id="zone-actif-immo" class="min-h-[60px] space-y-1 mt-2"></div><div class="zone-total" id="total-actif-immo">0 ‚Ç¨</div>
                                    </div>
                                    <div class="drop-zone p-2 rounded min-h-[100px]" ondrop="drop(event)" ondragover="allowDrop(event)" data-type="ACTIF" data-subtype="CIRC">
                                        <div class="block-header bg-blue-800"><span>Actif Circulant</span><span class="text-[0.6rem] opacity-70">Cl. 3, 4, 5</span></div><div id="zone-actif-circ" class="min-h-[60px] space-y-1 mt-2"></div><div class="zone-total" id="total-actif-circ">0 ‚Ç¨</div>
                                    </div>
                                </div>
                                <div class="bg-blue-50 p-2 text-right font-black font-mono-code text-blue-900 border-t-2 border-blue-900">TOTAL ACTIF: <span id="grand-total-actif">0 ‚Ç¨</span></div>
                            </div>
                            <div class="ledger-container border-red-900">
                                <div class="bg-red-100 p-2 font-bold text-center border-b-2 border-red-900 text-red-900">PASSIF (Ressources)</div>
                                <div class="p-3 space-y-3">
                                    <div class="drop-zone p-2 rounded min-h-[100px]" ondrop="drop(event)" ondragover="allowDrop(event)" data-type="PASSIF" data-subtype="CAPITAUX">
                                        <div class="block-header bg-red-900"><span>Capitaux Propres</span><span class="text-[0.6rem] opacity-70">Cl. 1 (Haut)</span></div><div id="zone-passif-capitaux" class="min-h-[60px] space-y-1 mt-2"></div><div class="zone-total" id="total-passif-capitaux">0 ‚Ç¨</div>
                                    </div>
                                    <div class="drop-zone p-2 rounded min-h-[100px]" ondrop="drop(event)" ondragover="allowDrop(event)" data-type="PASSIF" data-subtype="DETTES">
                                        <div class="block-header bg-red-800"><span>Dettes</span><span class="text-[0.6rem] opacity-70">Cl. 16, 40, 42...</span></div><div id="zone-passif-dettes" class="min-h-[60px] space-y-1 mt-2"></div><div class="zone-total" id="total-passif-dettes">0 ‚Ç¨</div>
                                    </div>
                                </div>
                                <div class="bg-red-50 p-2 text-right font-black font-mono-code text-red-900 border-t-2 border-red-900">TOTAL PASSIF: <span id="grand-total-passif">0 ‚Ç¨</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="chapter-2" class="hidden">
            <h2 class="text-2xl font-black font-serif-header mb-6">1. Comprendre la cascade des SIG</h2>
            
            <div class="max-w-4xl mx-auto mb-16">
                <div class="grid grid-cols-2 gap-8 mb-4">
                    <div class="sig-box has-info" onclick="toggleSigInfo(this)">
                        <div class="text-green-700 uppercase">Marge Commerciale</div>
                        <div class="sig-comment"> Ventes de marchandises <br>- Achats de marchandises <br>-/+ Variation de stock march.</div>
                    </div>
                    <div class="sig-box has-info" onclick="toggleSigInfo(this)">
                        <div class="text-green-700 uppercase">Production de l'exercice</div>
                        <div class="sig-comment">Production vendue <br>+ Prod. stock√©e <br>+ Prod. immobilis√©e</div>
                    </div>
                </div>

                <div class="arrow-down"></div>

                <div class="sig-box has-info mt-4 mx-auto w-3/4" onclick="toggleSigInfo(this)">
                    <div class="text-green-700 uppercase">Valeur Ajout√©e (VA)</div>
                    <div class="sig-comment">Marge Commerciale + Production <br>- Conso en provenance des tiers (Achats MP, Var Stock MP, Services ext√©rieurs...)</div>
                </div>

                <div class="arrow-down"></div>

                <div class="sig-box has-info mt-4 mx-auto w-3/4" onclick="toggleSigInfo(this)">
                    <div class="text-green-700 uppercase">EBE (Exc√©dent Brut d'Exploitation)</div>
                    <div class="sig-comment">VA + Subventions d'exploitation <br>- Imp√¥ts et taxes <br>- Charges de personnel</div>
                </div>

                <div class="arrow-down"></div>

                <div class="sig-box has-info mt-4 mx-auto w-3/4" onclick="toggleSigInfo(this)">
                    <div class="text-green-700 uppercase">REX (R√©sultat d'Exploitation)</div>
                    <div class="sig-comment">EBE + Autres produits <br>- Autres charges <br>+ Reprises sur amort/prov (RAP) <br>- Dotations aux amort/prov (DAP)</div>
                </div>

                <div class="arrow-down"></div>

                <div class="sig-box has-info mt-4 mx-auto w-3/4" onclick="toggleSigInfo(this)">
                    <div class="text-green-700 uppercase">RCAI (R√©sultat Courant)</div>
                    <div class="sig-comment">REX + Produits Financiers <br>- Charges Financi√®res</div>
                </div>

                <div class="arrow-down"></div>

                <div class="sig-box mt-4 mx-auto w-1/2 bg-green-100 border-green-500">
                    <div class="text-green-900 font-black uppercase text-xl">R√©sultat Net</div>
                    <div class="text-xs text-gray-500 mt-1">RCAI + R√©sultat Exceptionnel - IS - Participation</div>
                </div>
            </div>

            <h2 class="text-2xl font-black font-serif-header mb-6 border-t-4 border-gray-200 pt-8">2. Exercice Pratique</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-gray-100 p-6 border-2 border-gray-400 rounded">
                    <h3 class="font-bold mb-4 font-mono-code">DONN√âES COMPTABLES (Extrait)</h3>
                    <div id="sig-source-data" class="space-y-2 text-sm font-mono-code bg-white p-4 border border-gray-300 shadow-inner">
                        </div>
                    <button onclick="initSIGGame()" class="mt-4 text-xs underline text-gray-500 hover:text-black">G√©n√©rer nouvelles donn√©es</button>
                </div>

                <div class="bg-white p-6 border-4 border-gray-900 shadow-[8px_8px_0px_0px_#ccff00]">
                    <h3 class="font-bold mb-6 font-mono-code uppercase">Calculer les soldes</h3>
                    
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <label>1. Marge Commerciale</label>
                            <div class="flex items-center gap-2"><input type="number" id="inp-marge" class="hardcore-input" placeholder="?">‚Ç¨</div>
                        </div>
                        <div class="flex justify-between items-center">
                            <label>2. Production de l'ex.</label>
                            <div class="flex items-center gap-2"><input type="number" id="inp-prod" class="hardcore-input" placeholder="?">‚Ç¨</div>
                        </div>
                        <div class="flex justify-between items-center font-bold">
                            <label>3. Valeur Ajout√©e (VA)</label>
                            <div class="flex items-center gap-2"><input type="number" id="inp-va" class="hardcore-input" placeholder="?">‚Ç¨</div>
                        </div>
                        <div class="flex justify-between items-center font-bold">
                            <label>4. EBE</label>
                            <div class="flex items-center gap-2"><input type="number" id="inp-ebe" class="hardcore-input" placeholder="?">‚Ç¨</div>
                        </div>
                        <div class="flex justify-between items-center">
                            <label>5. R√©sultat Exploitation (REX)</label>
                            <div class="flex items-center gap-2"><input type="number" id="inp-rex" class="hardcore-input" placeholder="?">‚Ç¨</div>
                        </div>
                        <div class="flex justify-between items-center">
                            <label>6. RCAI</label>
                            <div class="flex items-center gap-2"><input type="number" id="inp-rcai" class="hardcore-input" placeholder="?">‚Ç¨</div>
                        </div>
                        <div class="flex justify-between items-center bg-green-50 p-2 -mx-2 border border-green-200">
                            <label class="font-black text-green-700">7. R√âSULTAT NET</label>
                            <div class="flex items-center gap-2"><input type="number" id="inp-rn" class="hardcore-input bg-white" placeholder="?">‚Ç¨</div>
                        </div>
                    </div>

                    <button onclick="validateSIG()" class="w-full mt-6 py-3 bg-gray-900 text-[#ccff00] font-bold uppercase hover:bg-white hover:text-gray-900 border-2 border-gray-900 transition-colors">
                        V√©rifier mes calculs
                    </button>
                    <div id="sig-feedback" class="mt-4 text-center font-bold hidden"></div>
                </div>
            </div>
        </div>

    </div>

    <div id="footer-chap1" class="sig-panel fixed bottom-0 left-0 w-full px-4 py-3 flex flex-col md:flex-row justify-between items-center gap-4 text-sm md:text-base">
        <div class="flex flex-wrap gap-6 items-center justify-center md:justify-start">
            <div class="flex flex-col"><span class="text-[0.65rem] uppercase text-gray-400">R√©sultat Net</span><span id="sig-res-net" class="sig-value font-bold text-xl text-white">0 ‚Ç¨</span></div>
            <div class="w-px h-8 bg-gray-700 hidden md:block"></div>
            <div class="flex flex-col"><span class="text-[0.65rem] uppercase text-gray-400">√âquilibre</span><span id="bilan-check" class="font-bold text-lg text-red-500">NON</span></div>
        </div>
        <div class="flex gap-4">
            <button onclick="exportToTXT()" class="px-6 py-3 bg-gray-700 text-white font-bold uppercase tracking-widest hover:bg-gray-600 transition-colors shadow-lg cursor-pointer rounded-sm flex items-center gap-2 text-xs md:text-sm">üìÅ Exporter</button>
            <button id="validate-btn" onclick="validate()" class="px-8 py-3 bg-[#ccff00] text-gray-900 font-black uppercase tracking-widest hover:bg-white transition-colors shadow-lg cursor-pointer rounded-sm">V√©rifier</button>
        </div>
    </div>

    <script>
        // GLOBAL STATE
        let currentChapter = 1;
        let currentDifficulty = 'EASY'; 
        let currentCompanyName = "";
        let journalEntries = [];
        let gameItems = [];
        let sigSolution = {}; // Stores correct SIG values

        // VIPs
        const winners = [
            { name: "Napol√©on", img: "https://preview.redd.it/v1dgm9hm3sp91.png?auto=webp&s=d7a42b8398951654be0ae5c87f6fecf478c86044", quote: "Impossible n'est pas comptable.<br>Une victoire strat√©gique √©clatante !" },
            { name: "Ichiban Kasuga", img: "https://gamejolt.com/p/portrait-of-ichiban-kasuga-wearing-yellow-headphones-for-an-art-com-f4dyrphy", quote: "Critique Hit sur le Bilan !<br>Tu as pass√© le niveau, Kyodai !" },
            { name: "Neymar JR", img: "https://www.pixelart.name/wp-content/uploads/2024/01/pixelart_name_footballer_neymar_difficult.png", quote: "GOOOOOAL !<br>Un √©quilibre technique tout simplement parfait." },
            { name: "Michel Houellebecq", img: "https://image.noelshack.com/fichiers/2025/49/5/1764928236-houellbcq.png", quote: "Dans un monde froid et vide,<br>ce bilan √©quilibr√© est la seule v√©rit√© tangible." }
        ];

        // CONFIG & DATA
        const prefixes = ["Boulangerie", "Garage", "Start-up", "Cabinet", "Boucherie", "Agence", "Pizzeria", "Cr√®che", "Pharmacie", "EHPAD"];
        const suffixes = ["'Chez D√©d√©'", "'Le Gouffre'", "'L'Optimiste'", "'Dernier Recours'", "'Le Blanchisseur'", "'Au Bonheur'"];
        const TYPES = { CHARGE: 'CHARGE', PRODUIT: 'PRODUIT', ACTIF: 'ACTIF', PASSIF: 'PASSIF' };
        const SUBS = { EXPLOIT: 'EXPLOIT', FINANCE: 'FINANCE', EXCEP: 'EXCEP', IMMO: 'IMMO', CIRC: 'CIRC', CAPITAUX: 'CAPITAUX', DETTES: 'DETTES' };

        const DATABASE_FULL = [
            { label: "Achats de marchandises", type: TYPES.CHARGE, sub: SUBS.EXPLOIT, code: '607' },
            { label: "Variation de stocks (stockage)", type: TYPES.CHARGE, sub: SUBS.EXPLOIT, code: '603' },
            { label: "Imp√¥ts, taxes et versements", type: TYPES.CHARGE, sub: SUBS.EXPLOIT, code: '63' },
            { label: "Salaires et traitements", type: TYPES.CHARGE, sub: SUBS.EXPLOIT, code: '641' },
            { label: "Charges sociales", type: TYPES.CHARGE, sub: SUBS.EXPLOIT, code: '645' },
            { label: "Dotations aux amortissements", type: TYPES.CHARGE, sub: SUBS.EXPLOIT, code: '681' },
            { label: "Int√©r√™ts pay√©s", type: TYPES.CHARGE, sub: SUBS.FINANCE, code: '66' },
            { label: "Produits des participations", type: TYPES.PRODUIT, sub: SUBS.FINANCE, code: '76' },
            { label: "Ventes de marchandises (CA)", type: TYPES.PRODUIT, sub: SUBS.EXPLOIT, code: '707' },
            { label: "Redevances (brevets, licences)", type: TYPES.PRODUIT, sub: SUBS.EXPLOIT, code: '751' },
            { label: "Quotes-parts de r√©sultat", type: TYPES.PRODUIT, sub: SUBS.EXPLOIT, code: '755' },
            { label: "Subventions d'exploitation", type: TYPES.PRODUIT, sub: SUBS.EXPLOIT, code: '74' },
            { label: "Produits exceptionnels", type: TYPES.PRODUIT, sub: SUBS.EXCEP, code: '771' },
            { label: "Charges exceptionnelles", type: TYPES.CHARGE, sub: SUBS.EXCEP, code: '671' },
            { label: "Int√©r√™ts re√ßus", type: TYPES.PRODUIT, sub: SUBS.FINANCE, code: '76' },
            { label: "Dotations aux provisions", type: TYPES.CHARGE, sub: SUBS.EXPLOIT, code: '681' },
            { label: "Autres charges d'exploitation", type: TYPES.CHARGE, sub: SUBS.EXPLOIT, code: '65' },
            { label: "Reprises sur amortissements", type: TYPES.PRODUIT, sub: SUBS.EXPLOIT, code: '78' },
            { label: "Val. Comptable Elts C√©d√©s (VCEAC)", type: TYPES.CHARGE, sub: SUBS.EXCEP, code: '675' },
            { label: "Prod. Cession Elts Actif (PCEA)", type: TYPES.PRODUIT, sub: SUBS.EXCEP, code: '775' },
            { label: "Capital Social", type: TYPES.PASSIF, sub: SUBS.CAPITAUX, code: '101' },
            { label: "Emprunts Bancaires", type: TYPES.PASSIF, sub: SUBS.DETTES, code: '164' },
            { label: "Stock Final Marchandises", type: TYPES.ACTIF, sub: SUBS.CIRC, code: '37' }
        ];

        // --- CHAPTER NAVIGATION ---
        function switchChapter(chapId) {
            currentChapter = chapId;
            // Tabs
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${chapId}`).classList.add('active');
            
            // Content
            if(chapId === 1) {
                document.getElementById('chapter-1').classList.remove('hidden');
                document.getElementById('chapter-2').classList.add('hidden');
                document.getElementById('footer-chap1').classList.remove('hidden');
            } else {
                document.getElementById('chapter-1').classList.add('hidden');
                document.getElementById('chapter-2').classList.remove('hidden');
                document.getElementById('footer-chap1').classList.add('hidden');
                initSIGGame(); // Load SIG game
            }
        }

        // --- SIG DIAGRAM INTERACTION ---
        function toggleSigInfo(element) {
            const comment = element.querySelector('.sig-comment');
            if (comment.style.display === 'block') {
                comment.style.display = 'none';
            } else {
                comment.style.display = 'block';
            }
        }

        // --- SIG EXERCISE LOGIC ---
        function initSIGGame() {
            // Generates random data for a full CDR to analyze
            const d = {};
            const r = (min, max) => Math.floor(Math.random() * (max - min) + min);

            // 1. Data Generation
            d.ventes = r(20000, 50000);
            d.achatsMarch = r(8000, 15000);
            d.varStockMarch = r(-2000, 2000); // Negative = destockage (charge), Positive = stockage (reduction charge) -> In PCG formula: Cost = Achats - Var (+ if Stock decrease, - if increase). 
            // SIMPLIFICATION for SIG: Marge = Ventes - (Achats - VarStock)
            
            d.prodVendue = r(5000, 15000);
            d.prodStockee = r(-1000, 3000);
            d.prodImmo = r(0, 2000); // often 0
            
            d.achatsMP = r(2000, 5000);
            d.varStockMP = r(-500, 500);
            d.servicesExt = r(3000, 8000); // 61/62
            
            d.subventions = r(0, 2000);
            d.impots = r(500, 1500); // 63
            d.personnel = r(5000, 12000); // 64
            
            d.autresProdExploit = r(0, 500);
            d.autresChargesExploit = r(0, 500);
            d.rap = r(0, 1000);
            d.dap = r(1000, 4000);
            
            d.prodFi = r(0, 500);
            d.chargesFi = r(200, 1000);
            
            d.prodExcep = r(0, 2000);
            d.chargesExcep = r(0, 2000);
            
            d.participation = 0; // Simplify
            d.is = 0; // Simplify or estimate

            // 2. Calculate Correct SIG
            const consoTiers = d.achatsMP - d.varStockMP + d.servicesExt; // Note on signs: VarStock Crediteur (prod) or Debiteur (Charge). Let's assume standard values.
            // Let's stick to the visual formula provided in the diagram:
            // Marge Co = Ventes - Achats Marchandises - (-VarStockMarch if creditor, + if debitor). 
            // Standard convention here: "Achats consomm√©s" = Achats - Variation (if Var = SF - SI). 
            // Let's assume the values provided are the accounting balances.
            // If Var Stock > 0 (Stock Increase, SF>SI), it's a CREDIT (Product-like).
            // If Var Stock < 0 (Stock Decrease), it's a DEBIT (Charge).
            
            // To make it unambiguous for the player, we will display "Co√ªt d'achat des marchandises vendues" directly or detailed lines.
            // Let's display lines.
            
            const margeCo = d.ventes - d.achatsMarch + d.varStockMarch; // Assuming varStock is signed (Pos = Stockage/Profit, Neg = Destockage/Loss)
            const production = d.prodVendue + d.prodStockee + d.prodImmo;
            const va = margeCo + production - (d.achatsMP - d.varStockMP + d.servicesExt);
            const ebe = va + d.subventions - d.impots - d.personnel;
            const rex = ebe + d.autresProdExploit - d.autresChargesExploit + d.rap - d.dap;
            const rcai = rex + d.prodFi - d.chargesFi;
            const rn = rcai + (d.prodExcep - d.chargesExcep) - d.is - d.participation;

            sigSolution = { margeCo, production, va, ebe, rex, rcai, rn };

            // 3. Render Source Data
            const html = `
                <div class="flex justify-between"><span>Ventes Marchandises (707)</span><span>${d.ventes} ‚Ç¨</span></div>
                <div class="flex justify-between"><span>Achats Marchandises (607)</span><span>${d.achatsMarch} ‚Ç¨</span></div>
                <div class="flex justify-between"><span>Var. Stocks March. (6037)</span><span>${d.varStockMarch} ‚Ç¨</span></div>
                <div class="border-t border-gray-300 my-1"></div>
                <div class="flex justify-between"><span>Prod. Vendue (Biens/Services)</span><span>${d.prodVendue} ‚Ç¨</span></div>
                <div class="flex justify-between"><span>Prod. Stock√©e/Immo</span><span>${d.prodStockee + d.prodImmo} ‚Ç¨</span></div>
                <div class="flex justify-between"><span>Achats MP & Autres Appro (601/602)</span><span>${d.achatsMP} ‚Ç¨</span></div>
                <div class="flex justify-between"><span>Var. Stock MP (6031)</span><span>${d.varStockMP} ‚Ç¨</span></div>
                <div class="flex justify-between"><span>Services Ext√©rieurs (61/62)</span><span>${d.servicesExt} ‚Ç¨</span></div>
                <div class="border-t border-gray-300 my-1"></div>
                <div class="flex justify-between"><span>Subventions d'exploit. (74)</span><span>${d.subventions} ‚Ç¨</span></div>
                <div class="flex justify-between"><span>Imp√¥ts & Taxes (63)</span><span>${d.impots} ‚Ç¨</span></div>
                <div class="flex justify-between"><span>Charges Personnel (64)</span><span>${d.personnel} ‚Ç¨</span></div>
                <div class="border-t border-gray-300 my-1"></div>
                <div class="flex justify-between"><span>Autres Prod / Charges Exploit.</span><span>${d.autresProdExploit - d.autresChargesExploit} ‚Ç¨</span></div>
                <div class="flex justify-between"><span>Reprises (RAP) (78)</span><span>${d.rap} ‚Ç¨</span></div>
                <div class="flex justify-between"><span>Dotations (DAP) (68)</span><span>${d.dap} ‚Ç¨</span></div>
                <div class="border-t border-gray-300 my-1"></div>
                <div class="flex justify-between"><span>Produits Financiers</span><span>${d.prodFi} ‚Ç¨</span></div>
                <div class="flex justify-between"><span>Charges Financi√®res</span><span>${d.chargesFi} ‚Ç¨</span></div>
                <div class="flex justify-between text-gray-500 text-xs"><span>R√©sultat Exceptionnel</span><span>${d.prodExcep - d.chargesExcep} ‚Ç¨</span></div>
            `;
            document.getElementById('sig-source-data').innerHTML = html;
            
            // Clear inputs
            document.querySelectorAll('#chapter-2 input').forEach(i => { i.value = ''; i.classList.remove('bg-red-100', 'bg-green-100'); });
            document.getElementById('sig-feedback').classList.add('hidden');
        }

        function validateSIG() {
            const inputs = {
                margeCo: parseInt(document.getElementById('inp-marge').value),
                production: parseInt(document.getElementById('inp-prod').value),
                va: parseInt(document.getElementById('inp-va').value),
                ebe: parseInt(document.getElementById('inp-ebe').value),
                rex: parseInt(document.getElementById('inp-rex').value),
                rcai: parseInt(document.getElementById('inp-rcai').value),
                rn: parseInt(document.getElementById('inp-rn').value)
            };

            let errors = 0;
            const check = (key, id) => {
                const el = document.getElementById(id);
                // Allow small margin of error? No, exact calculation.
                if (inputs[key] === sigSolution[key]) {
                    el.classList.add('bg-green-100');
                    el.classList.remove('bg-red-100');
                } else {
                    el.classList.add('bg-red-100');
                    el.classList.remove('bg-green-100');
                    errors++;
                }
            };

            check('margeCo', 'inp-marge');
            check('production', 'inp-prod');
            check('va', 'inp-va');
            check('ebe', 'inp-ebe');
            check('rex', 'inp-rex');
            check('rcai', 'inp-rcai');
            check('rn', 'inp-rn');

            const fb = document.getElementById('sig-feedback');
            fb.classList.remove('hidden');
            if (errors === 0) {
                fb.innerText = "Tout est correct ! Excellent analyste.";
                fb.className = "mt-4 text-center font-bold text-green-600";
                // Show Victory Modal for SIG
                document.getElementById('victory-content').innerHTML = `
                    <h2 class="text-4xl font-black font-mono-code uppercase text-[#dc2626] transform -rotate-2">Analyste Confirm√© !</h2>
                    <p class="font-serif-header italic text-gray-600 mt-4">Les SIG n'ont plus de secrets pour toi.</p>
                `;
                document.getElementById('victory-modal').classList.remove('hidden');
            } else {
                fb.innerText = `Il y a ${errors} erreurs. V√©rifie tes formules.`;
                fb.className = "mt-4 text-center font-bold text-red-600";
            }
        }

        // --- CHAPTER 1 JS LOGIC (Existing) ---
        function initStandardMode() {
            gameItems = [];
            const selection = [...DATABASE_FULL].sort(() => 0.5 - Math.random()).slice(0, 12);
            let tC=0, tP=0, tA=0, tPas=0;
            selection.forEach((op, i) => {
                const amount = Math.floor(Math.random()*4000)+100;
                gameItems.push({...op, id:`op-${i}`, amount});
                if(op.type===TYPES.CHARGE) tC+=amount; if(op.type===TYPES.PRODUIT) tP+=amount; if(op.type===TYPES.ACTIF) tA+=amount; if(op.type===TYPES.PASSIF) tPas+=amount;
            });
            const res = tP - tC;
            gameItems.push({ id:'op-res', label:"R√©sultat Net", type:TYPES.PASSIF, sub:SUBS.CAPITAUX, code:'120', amount:res });
            tPas += res;
            const bank = tPas - tA;
            if(bank>=0) gameItems.push({id:'op-bank', label:"Banque (Solde)", type:TYPES.ACTIF, sub:SUBS.CIRC, code:'512', amount:bank});
            else gameItems.push({id:'op-bank', label:"D√©couvert", type:TYPES.PASSIF, sub:SUBS.DETTES, code:'512', amount:Math.abs(bank)});
            renderCards(); updateCalculations();
        }

        function initHardcoreMode() {
            gameItems = []; const journalDiv = document.getElementById('journal-content'); const ledger = {}; const durationMul = parseInt(document.getElementById('game-duration').value);
            let currentSupplierDebt=0, currentCustomerReceivable=0;
            const impact = (label, type, sub, code, amount, isDebit) => {
                const key = code; if(!ledger[key]) ledger[key]={label, type, sub, code, balance:0};
                if(type===TYPES.ACTIF || type===TYPES.CHARGE) ledger[key].balance+=isDebit?amount:-amount; else ledger[key].balance+=isDebit?-amount:amount;
            };
            const addEntry = (date, text) => { journalEntries.push(`${date} : ${text}`); const p=document.createElement('p'); p.innerHTML=`<strong>${date}</strong> : ${text}`; p.className="border-b border-blue-200 pb-1"; journalDiv.appendChild(p); };
            let currentDate=new Date(2024,0,1); const nextDate=()=>{currentDate.setDate(currentDate.getDate()+Math.floor(Math.random()*5)+2); return currentDate.toLocaleDateString('fr-FR');};
            
            const capital=30000; impact("Capital Social", TYPES.PASSIF, SUBS.CAPITAUX, '101', capital, false); impact("Banque", TYPES.ACTIF, SUBS.CIRC, '512', capital, true); addEntry("01/01/2024", `Capital social : ${capital}‚Ç¨.`);
            const loops=4*durationMul; 
            for(let i=0; i<loops; i++) {
                const rand=Math.random();
                if(rand<0.15){ const v=2000,p=2500; impact("Val. Comptable Elts C√©d√©s", TYPES.CHARGE, SUBS.EXCEP, '675', v, true); impact("Prod. Cession Elts Actif", TYPES.PRODUIT, SUBS.EXCEP, '775', p, false); impact("Banque", TYPES.ACTIF, SUBS.CIRC, '512', p, true); addEntry(nextDate(), `Cession actif (VNC:${v}‚Ç¨) pour ${p}‚Ç¨.`); }
                else if(rand<0.25){ const s=1000; impact("Subventions d'exploitation", TYPES.PRODUIT, SUBS.EXPLOIT, '74', s, false); impact("Banque", TYPES.ACTIF, SUBS.CIRC, '512', s, true); addEntry(nextDate(), `Subvention re√ßue : ${s}‚Ç¨.`); }
                else if(rand<0.7){ const a=1000+Math.floor(Math.random()*2000); if(Math.random()>0.5){ impact("Achats de marchandises", TYPES.CHARGE, SUBS.EXPLOIT, '607', a, true); impact("Dettes Fournisseurs", TYPES.PASSIF, SUBS.DETTES, '401', a, false); currentSupplierDebt+=a; addEntry(nextDate(), `Achat marchandise cr√©dit : ${a}‚Ç¨.`); } else { impact("Ventes de marchandises", TYPES.PRODUIT, SUBS.EXPLOIT, '707', a, false); impact("Banque", TYPES.ACTIF, SUBS.CIRC, '512', a, true); addEntry(nextDate(), `Vente comptant : ${a}‚Ç¨.`); } }
            }
            impact("Salaires", TYPES.CHARGE, SUBS.EXPLOIT, '641', 3000, true); impact("Banque", TYPES.ACTIF, SUBS.CIRC, '512', 3000, false); addEntry(nextDate(), "Salaires : 3000‚Ç¨.");
            const stock=5000; impact("Stock Final Marchandises", TYPES.ACTIF, SUBS.CIRC, '37', stock, true); impact("Variation de stocks", TYPES.CHARGE, SUBS.EXPLOIT, '603', stock, false); addEntry("31/12/2024", `Stock final : ${stock}‚Ç¨.`);
            
            let tC=0, tP=0; Object.values(ledger).forEach(acc=>{if(acc.type===TYPES.CHARGE)tC+=acc.balance;if(acc.type===TYPES.PRODUIT)tP+=acc.balance;});
            ledger['120']={label:"R√©sultat (√† calculer !)", type:TYPES.PASSIF, sub:SUBS.CAPITAUX, code:'120', balance:tP-tC};
            Object.values(ledger).forEach((acc, i)=>{if(Math.abs(acc.balance)>0) gameItems.push({id:`op-${i}`, label:acc.label, type:acc.type, sub:acc.sub, code:acc.code, amount:acc.balance, isHardcore:true});});
            renderCards(); updateCalculations();
        }

        function setDifficulty(mode) {
            currentDifficulty = mode;
            document.querySelectorAll('.diff-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${mode.toLowerCase()}`).classList.add('active');
            const journal = document.getElementById('journal-panel');
            const slider = document.getElementById('duration-control');
            if(mode === 'HARDCORE') { journal.classList.remove('hidden'); slider.classList.remove('hidden'); } else { journal.classList.add('hidden'); slider.classList.add('hidden'); }
            initGame();
        }
        function initGame() {
            currentCompanyName = `${prefixes[Math.floor(Math.random()*prefixes.length)]} ${suffixes[Math.floor(Math.random()*suffixes.length)]}`;
            document.getElementById('company-name').innerText = currentCompanyName;
            closeModal(); journalEntries = [];
            document.querySelectorAll('.drop-zone div[id^="zone-"]').forEach(z => z.innerHTML = '');
            document.getElementById('source-zone').innerHTML = ''; document.getElementById('journal-content').innerHTML = '';
            const btn = document.getElementById('validate-btn'); btn.innerText = "V√©rifier"; btn.classList.replace('bg-white', 'bg-[#ccff00]');
            if(currentDifficulty === 'HARDCORE') initHardcoreMode(); else initStandardMode();
        }
        function renderCards() { const z = document.getElementById('source-zone'); gameItems.sort(() => 0.5 - Math.random()).forEach(i => z.appendChild(createCard(i))); }
        function createCard(item) {
            const div = document.createElement('div'); div.id = item.id; div.className = "sketchy-card p-2 cursor-grab animate-pop mb-2 text-sm"; div.draggable = true;
            div.dataset.type = item.type; div.dataset.sub = item.sub; div.dataset.trueAmount = item.amount; div.dataset.currentAmount = currentDifficulty === 'HARDCORE' ? 0 : item.amount; div.dataset.label = item.label;
            let display = (currentDifficulty === 'HARDCORE') ? `<input type="number" class="hardcore-input" placeholder="?" onmousedown="event.stopPropagation()" oninput="updateCardAmount(this)"> ‚Ç¨` : `${item.amount.toLocaleString('fr-FR')} ‚Ç¨`;
            let code = (currentDifficulty === 'EASY') ? `<span class="font-mono-code text-[0.65rem] bg-gray-200 px-1 rounded text-gray-800">${item.code}</span>` : ``;
            div.innerHTML = `<div class="flex justify-between items-start pointer-events-none"><span class="font-bold leading-tight pr-2 text-gray-900">${item.label}</span>${code}</div><div class="mt-1 text-right font-mono-code font-bold text-gray-600">${display}</div>`;
            div.addEventListener('dragstart', (e) => { if(e.target.tagName === 'INPUT') {e.preventDefault(); return;} e.target.classList.remove('valid-success', 'valid-error'); e.dataTransfer.setData("text", e.target.id); setTimeout(() => e.target.classList.add('dragging'), 0); });
            div.addEventListener('dragend', (e) => { e.target.classList.remove('dragging'); updateCalculations(); });
            return div;
        }
        function updateCardAmount(input) { input.closest('.sketchy-card').dataset.currentAmount = parseInt(input.value) || 0; updateCalculations(); }
        function allowDrop(ev) { ev.preventDefault(); }
        function drop(ev) {
            ev.preventDefault(); const data = ev.dataTransfer.getData("text"); const el = document.getElementById(data); if(!el) return;
            let target = ev.target; while(target && !target.classList.contains('drop-zone') && target.id !== 'source-zone') target = target.parentNode; if(!target) return;
            let container = target.classList.contains('drop-zone') ? target.querySelector('div[id^="zone-"]') : target;
            if(container) { container.appendChild(el); el.style.transform = container.id !== 'source-zone' ? `rotate(${Math.random() * 2 - 1}deg)` : 'none'; }
            updateCalculations();
        }
        function updateCalculations() {
            const sum = (id) => { const z = document.getElementById(id); if(!z) return 0; let t = 0; for(let c of z.children) t += parseInt(c.dataset.currentAmount || 0); return t; };
            const m = { 'zone-charge-exploit': 'total-charge-exploit', 'zone-charge-finance': 'total-charge-finance', 'zone-charge-excep': 'total-charge-excep', 'zone-produit-exploit': 'total-produit-exploit', 'zone-produit-finance': 'total-produit-finance', 'zone-produit-excep': 'total-produit-excep', 'zone-actif-immo': 'total-actif-immo', 'zone-actif-circ': 'total-actif-circ', 'zone-passif-capitaux': 'total-passif-capitaux', 'zone-passif-dettes': 'total-passif-dettes' };
            for(const [z, d] of Object.entries(m)) document.getElementById(d).innerText = sum(z).toLocaleString('fr-FR') + ' ‚Ç¨';
            const tA = sum('zone-actif-immo') + sum('zone-actif-circ'); const tP = sum('zone-passif-capitaux') + sum('zone-passif-dettes');
            const charges = sum('zone-charge-exploit') + sum('zone-charge-finance') + sum('zone-charge-excep'); const prods = sum('zone-produit-exploit') + sum('zone-produit-finance') + sum('zone-produit-excep');
            document.getElementById('sig-res-net').innerText = (prods - charges).toLocaleString('fr-FR') + ' ‚Ç¨';
            const check = document.getElementById('bilan-check');
            if(tA > 0 && Math.abs(tA - tP) < 2) { check.innerText = "OUI"; check.className = "font-bold text-lg text-[#ccff00]"; } else { check.innerText = "NON"; check.className = "font-bold text-lg text-red-500"; }
        }
        function validate() {
            let err = 0, total = 0;
            document.querySelectorAll('.drop-zone').forEach(z => {
                const expT = z.dataset.type; const expS = z.dataset.subtype;
                for(let item of z.querySelector('div[id^="zone-"]').children) {
                    total++; let posOk = (item.dataset.type === expT && item.dataset.sub === expS);
                    let valOk = true; if(currentDifficulty === 'HARDCORE') valOk = Math.abs(parseInt(item.dataset.currentAmount)) === Math.abs(parseInt(item.dataset.trueAmount));
                    item.classList.remove('valid-success', 'valid-error'); if(posOk && valOk) item.classList.add('valid-success'); else { item.classList.add('valid-error'); err++; }
                }
            });
            const left = document.getElementById('source-zone').children.length; const bal = document.getElementById('bilan-check').innerText === "OUI"; const btn = document.getElementById('validate-btn');
            if(err === 0 && left === 0 && bal) {
                btn.innerText = "Parfait !";
                const winner = winners[Math.floor(Math.random() * winners.length)];
                document.getElementById('victory-content').innerHTML = `<img src="${winner.img}" alt="${winner.name}" class="w-32 h-32 mx-auto mb-4 border-4 border-gray-900 rounded-full bg-[#ccff00] pixelated-img object-cover"><h2 class="text-4xl font-black font-mono-code uppercase text-[#dc2626] leading-tight mb-2 transform -rotate-2">${winner.name}</h2><p class="font-serif-header italic text-gray-600 text-sm mt-4">"${winner.quote}"</p>`;
                document.getElementById('victory-modal').classList.remove('hidden');
            } else { btn.innerText = `${err} Erreurs / ${left} Restants`; setTimeout(() => btn.innerText = "V√©rifier", 2000); }
        }
        function exportToTXT() {
            let c = `EXERCICE - ${currentCompanyName}\nDIFFICULTE: ${currentDifficulty}\n\n=== JOURNAL ===\n${journalEntries.join('\n')}\n\n=== REPONSES ===\n`;
            document.querySelectorAll('.drop-zone, #source-zone').forEach(z => {
                let n = z.id; if(z.dataset.type) n = `${z.dataset.type}-${z.dataset.subtype}`;
                const cont = z.querySelector('div[id^="zone-"]') || z;
                for(let i of cont.children) c += `ZONE: ${n} | CARTE: ${i.dataset.label} | SAISIE: ${i.dataset.currentAmount} | ATTENDU: ${i.dataset.trueAmount}\n`;
            });
            const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([c], { type: "text/plain" })); a.download = `compta_export.txt`; a.click();
        }
        function closeModal() { document.getElementById('victory-modal').classList.add('hidden'); }
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
