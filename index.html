<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compta Boost√©e - V25 FINAL</title>
    
    <link rel="icon" href="https://iili.io/fuLcJvs.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,400;1,700&family=Roboto+Mono:wght@400;700&family=Inter:wght@400;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Gloria+Hallelujah&display=swap" rel="stylesheet">

    <style>
        :root { --neon-yellow: #ccff00; --dark: #1a1a1a; --paper: #ffffff; --soft-grid: #e5e7eb; --ledger-line: #bfdbfe; --sig-green: #dcfce7; --sig-gray: #f3f4f6; }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: var(--dark); background-image: linear-gradient(var(--soft-grid) 1px, transparent 1px), linear-gradient(90deg, var(--soft-grid) 1px, transparent 1px); background-size: 20px 20px; padding-bottom: 140px; }
        .font-serif-header { font-family: 'Playfair Display', serif; }
        .font-mono-code { font-family: 'Roboto Mono', monospace; }
        .font-hand { font-family: 'Gloria Hallelujah', cursive; }

        /* UI ELEMENTS */
        .sketchy-card { background: var(--paper); border: 2px solid var(--dark); border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px; box-shadow: 2px 2px 0px 0px rgba(0,0,0,0.8); transition: all 0.2s ease; color: var(--dark); cursor: grab; }
        .sketchy-card:active { cursor: grabbing; }
        .sketchy-card:hover { transform: translateY(-2px) rotate(1deg); box-shadow: 4px 4px 0px 0px var(--neon-yellow); z-index: 50; }
        .drop-zone { transition: background-color 0.3s, border-color 0.3s; border: 2px dashed #9ca3af; background-color: rgba(255, 255, 255, 0.4); display: flex; flex-direction: column; }
        .drop-zone:hover { border-color: var(--dark); background-color: rgba(255, 255, 255, 0.9); }
        .block-header { background: var(--dark); color: #fff; padding: 4px 8px; font-family: 'Roboto Mono', monospace; font-size: 0.75rem; text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; }
        .zone-total { margin-top: auto; border-top: 2px dotted var(--dark); padding-top: 4px; text-align: right; font-family: 'Roboto Mono', monospace; font-weight: bold; font-size: 0.8rem; }

        /* CALCULATOR */
        #calc-bubble { position: fixed; bottom: 100px; right: 30px; width: 60px; height: 60px; background-color: var(--dark); color: var(--neon-yellow); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; cursor: pointer; box-shadow: 4px 4px 0px rgba(0,0,0,0.3); z-index: 60; transition: transform 0.2s; border: 3px solid white; }
        #calc-bubble:hover { transform: scale(1.1) rotate(10deg); }
        #calc-window { position: fixed; bottom: 170px; right: 30px; width: 280px; background-color: white; border: 4px solid var(--dark); border-radius: 8px; box-shadow: 10px 10px 0px rgba(0,0,0,0.4); z-index: 60; display: none; font-family: 'Roboto Mono', monospace; }
        #calc-header { background-color: var(--dark); color: var(--neon-yellow); padding: 10px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; cursor: move; }
        #calc-display { width: 100%; height: 60px; border: none; border-bottom: 4px solid var(--dark); text-align: right; padding: 10px; font-size: 1.8rem; outline: none; background: #f3f4f6; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px; background: var(--dark); padding: 2px; }
        .calc-btn { background: white; border: none; padding: 15px 0; font-size: 1.2rem; font-weight: bold; cursor: pointer; transition: background 0.1s; }
        .calc-btn:hover { background: #e5e7eb; }
        .calc-btn.op { background: #fef08a; } .calc-btn.eq { background: var(--neon-yellow); } .calc-btn.clear { background: #fca5a5; }

        /* SIG DIAGRAM */
        .sig-box { padding: 1rem; text-align: center; font-weight: 800; font-family: 'Roboto Mono', monospace; border-radius: 4px; position: relative; transition: all 0.2s; cursor: pointer; box-shadow: 3px 3px 0px rgba(0,0,0,0.1); border: 3px solid var(--dark); }
        .sig-box-title { text-transform: uppercase; }
        .sig-box-green { background-color: var(--sig-green); color: var(--dark); }
        .sig-box-gray { background-color: var(--sig-gray); color: #4b5563; font-size: 0.9rem; }
        .sig-box:hover { background-color: var(--neon-yellow) !important; color: var(--dark) !important; box-shadow: 5px 5px 0px 0px var(--dark); transform: translate(-2px, -2px); }
        .sig-bubble { display: none; position: absolute; left: 105%; top: 50%; transform: translateY(-50%); width: 280px; background-color: #fffbeb; background-image: repeating-linear-gradient(transparent, transparent 27px, #bfdbfe 28px); background-size: 100% 28px; line-height: 28px; padding: 15px 15px 15px 25px; border: 2px solid var(--dark); font-size: 0.9rem; text-align: left; font-weight: normal; font-family: 'Gloria Hallelujah', cursive; z-index: 20; box-shadow: 5px 5px 10px rgba(0,0,0,0.2); border-radius: 2px 15px 2px 15px; }
        .sig-bubble::before { content: ''; position: absolute; left: 15px; top: 0; bottom: 0; width: 2px; background-color: #ef4444; opacity: 0.5; }
        .arrow-down { width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 15px solid var(--dark); margin: 0 auto; }
        .line-down { width: 4px; height: 20px; background: var(--dark); margin: 0 auto; }

        /* OTHERS */
        .journal-paper { background-color: #fefce8; background-image: repeating-linear-gradient(var(--ledger-line) 0 1px, transparent 1px 100%); background-size: 100% 2rem; line-height: 2rem; box-shadow: 5px 5px 15px rgba(0,0,0,0.1); border-left: 4px double #ef4444; }
        .hardcore-input { border: none; border-bottom: 3px solid var(--dark); background: rgba(0,0,0,0.05); text-align: right; font-family: 'Roboto Mono', monospace; width: 100px; font-weight: bold; color: var(--dark); padding-right: 5px; }
        .hardcore-input:focus { outline: none; background: #ccff00; }
        .diff-btn { transition: all 0.2s; }
        .diff-btn.active { background-color: var(--neon-yellow); color: var(--dark); font-weight: 800; box-shadow: inset 2px 2px 0px rgba(0,0,0,0.1); }
        .pixelated-img { image-rendering: pixelated; }
        .valid-success { background-color: #d9f99d !important; border-color: #365314; }
        .valid-error { background-color: #fca5a5 !important; border-color: #7f1d1d; }
        .sig-panel { background: var(--dark); color: #fff; border-top: 4px solid var(--neon-yellow); box-shadow: 0 -10px 30px rgba(0,0,0,0.3); z-index: 50; }
        .nav-tab { cursor: pointer; padding: 10px 20px; font-weight: bold; font-family: 'Roboto Mono'; border-top-left-radius: 8px; border-top-right-radius: 8px; border: 2px solid transparent; border-bottom: none; opacity: 0.6; }
        .nav-tab.active { background: #f3f4f6; border-color: var(--dark); border-bottom: 2px solid #f3f4f6; opacity: 1; color: var(--dark); transform: translateY(2px); }
        .nav-tab:hover:not(.active) { opacity: 1; background: rgba(255,255,255,0.5); }
        .action-btn { padding: 0.5rem 1rem; background-color: white; border: 2px solid var(--dark); box-shadow: 3px 3px 0px 0px var(--neon-yellow); font-weight: bold; font-family: 'Roboto Mono', monospace; text-transform: uppercase; font-size: 0.75rem; cursor: pointer; transition: all 0.1s; }
        .action-btn:hover { box-shadow: none; transform: translate(2px, 2px); }
        .dragging { opacity: 0.4; transform: scale(0.9); }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes pop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="selection:bg-[#ccff00] min-h-screen relative">

    <div id="calc-bubble" onclick="toggleCalc()">üßÆ</div>
    <div id="calc-window">
        <div id="calc-header"><span>CALC-O-MATIC</span><span class="cursor-pointer hover:text-white" onclick="toggleCalc()">‚úñ</span></div>
        <input type="text" id="calc-display" readonly>
        <div class="calc-grid">
            <button class="calc-btn" onclick="calcAppend('1')">1</button><button class="calc-btn" onclick="calcAppend('2')">2</button><button class="calc-btn" onclick="calcAppend('3')">3</button><button class="calc-btn op" onclick="calcAppend('+')">+</button>
            <button class="calc-btn" onclick="calcAppend('4')">4</button><button class="calc-btn" onclick="calcAppend('5')">5</button><button class="calc-btn" onclick="calcAppend('6')">6</button><button class="calc-btn op" onclick="calcAppend('-')">-</button>
            <button class="calc-btn" onclick="calcAppend('7')">7</button><button class="calc-btn" onclick="calcAppend('8')">8</button><button class="calc-btn" onclick="calcAppend('9')">9</button><button class="calc-btn op" onclick="calcAppend('*')">x</button>
            <button class="calc-btn clear" onclick="calcClear()">C</button><button class="calc-btn" onclick="calcAppend('0')">0</button><button class="calc-btn eq" onclick="calcResult()">=</button><button class="calc-btn op" onclick="calcAppend('/')">/</button>
        </div>
    </div>

    <div id="tuto-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center z-[70] backdrop-blur-sm p-4">
        <div class="bg-white border-4 border-gray-900 p-6 md:p-8 relative max-w-3xl w-full shadow-[15px_15px_0px_0px_rgba(255,255,255,0.2)] flex flex-col" style="border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px; min-height: 500px;">
            <button onclick="closeTuto()" class="absolute top-4 right-6 text-4xl font-bold text-gray-400 hover:text-red-500 transition-colors cursor-pointer z-50">&times;</button>
            <div class="mb-6 border-b-2 border-gray-100 pb-4">
                <h2 class="text-3xl font-black font-mono-code uppercase border-b-4 border-[#ccff00] inline-block transform -rotate-1">Guide du Comptable</h2>
            </div>
            <div class="flex-grow p-4 text-center">
                <p class="mb-4">1. Glissez les cartes dans les bonnes cases.</p>
                <p class="mb-4">2. En mode <strong>Hardcore</strong>, lisez le journal et calculez les montants.</p>
                <p>3. Utilisez l'onglet <strong>SIG</strong> pour r√©viser la cascade des r√©sultats.</p>
            </div>
            <button onclick="closeTuto()" class="mt-4 px-6 py-2 bg-gray-900 text-[#ccff00] font-bold mx-auto block">Compris</button>
        </div>
    </div>

    <div id="victory-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-[100] backdrop-blur-sm">
        <div class="bg-white border-4 border-gray-900 p-8 relative max-w-md w-full text-center shadow-[10px_10px_0px_0px_#dc2626] animate-pop" style="border-radius: 5px 25px 5px 25px;">
            <button onclick="closeModal()" class="absolute top-2 right-4 text-3xl font-bold text-gray-400 hover:text-gray-900 transition-colors cursor-pointer">&times;</button>
            <div class="relative z-10" id="victory-content"></div>
        </div>
    </div>

    <div class="max-w-[1800px] mx-auto p-4 md:p-6">
        <header class="mb-2 flex flex-col xl:flex-row justify-between items-end border-b-4 border-gray-900 pb-4 border-double gap-4">
            <div>
                <div class="flex items-center gap-3">
                    <h1 class="text-4xl md:text-5xl font-extrabold tracking-tighter uppercase italic transform -rotate-1">COMPTA<span class="text-[#ccff00] bg-gray-900 px-2 transform skew-x-12 inline-block">BOOST√âE</span></h1>
                    <span class="bg-gray-200 text-xs px-2 py-1 font-mono-code rounded border border-gray-400">V25 FINAL</span>
                </div>
                <h2 id="company-name" class="mt-2 text-xl font-serif-header font-bold text-gray-800 border-b-2 border-[#ccff00] inline-block">Chargement...</h2>
            </div>
        </header>

        <div class="flex border-b-4 border-gray-900 mb-8">
            <div id="tab-1" onclick="switchChapter(1)" class="nav-tab active">CHAP 1 : BILAN & CDR</div>
            <div id="tab-2" onclick="switchChapter(2)" class="nav-tab">CHAP 2 : LES S.I.G</div>
        </div>

        <div id="chapter-1" class="block">
            <div class="flex flex-wrap gap-6 mb-6 items-center">
                <div id="duration-control" class="flex flex-col items-start gap-1 hidden">
                    <label class="text-xs font-bold font-mono-code uppercase text-gray-500">Dur√©e</label>
                    <div class="flex items-center gap-2"><span class="text-xs">Court</span><input type="range" id="game-duration" min="1" max="3" step="1" value="1" class="w-24 h-2 bg-gray-200 rounded-lg cursor-pointer border border-gray-900"><span class="text-xs">Long</span></div>
                </div>
                <div class="flex items-center gap-1 bg-white border-2 border-gray-900 p-1 shadow-sm rounded-full">
                    <button onclick="setDifficulty('EASY')" id="btn-easy" class="diff-btn active px-3 py-1 font-mono-code text-xs font-bold rounded-sm">EASY</button>
                    <button onclick="setDifficulty('NORMAL')" id="btn-normal" class="diff-btn px-3 py-1 font-mono-code text-xs font-bold rounded-sm hover:bg-gray-100">NORMAL</button>
                    <button onclick="setDifficulty('HARDCORE')" id="btn-hardcore" class="diff-btn px-3 py-1 font-mono-code text-xs font-bold rounded-sm hover:bg-gray-100 text-red-600">HARDCORE üî•</button>
                </div>
                <button onclick="initGame()" class="action-btn">‚ö° Reset</button>
                <button onclick="openTuto()" class="action-btn bg-yellow-200">‚ùì Aide</button>
            </div>

            <div class="grid grid-cols-12 gap-6">
                <div class="col-span-12 lg:col-span-3 flex flex-col gap-6">
                    <div id="journal-panel" class="hidden">
                        <div class="journal-paper p-4 border border-gray-300 min-h-[400px] max-h-[600px] overflow-y-auto shadow-xl relative transform -rotate-1">
                            <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-3 py-1 text-sm font-bold font-mono-code rotate-1">JOURNAL</div>
                            <div id="journal-content" class="font-hand text-gray-800 text-sm pt-4 space-y-4"></div>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-3 border-2 border-gray-900 rounded-lg relative shadow-xl">
                        <h3 class="text-neon-yellow font-bold mb-4 font-mono-code uppercase text-xs tracking-widest border-b border-gray-600 pb-2">FLUX ENTRANT</h3>
                        <div id="source-zone" class="space-y-2 min-h-[200px]" ondrop="drop(event)" ondragover="allowDrop(event)" data-type="TODO"></div>
                    </div>
                </div>

                <div class="col-span-12 lg:col-span-9 flex flex-col gap-10">
                    <div>
                        <h3 class="font-black text-2xl italic uppercase border-l-8 border-[#ccff00] pl-3 mb-4">I. Compte de R√©sultat</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="ledger-container">
                                <div class="bg-gray-200 p-2 font-bold text-center border-b-2 border-gray-900 flex justify-between items-center"><span>CHARGES</span><span class="text-xs bg-gray-900 text-white px-2 rounded">Cl. 6</span></div>
                                <div class="p-3 space-y-3">
                                    <div class="drop-zone p-2 rounded min-h-[80px]" ondrop="drop(event)" ondragover="allowDrop(event)" data-type="CHARGE" data-subtype="EXPLOIT"><div class="block-header"><span>Exploitation</span></div><div id="zone-charge-exploit" class="min-h-[40px] space-y-1 mt-2"></div><div class="zone-total" id="total-charge-exploit">0 ‚Ç¨</div></div>
                                    <div class="drop-zone p-2 rounded min-h-[80px]" ondrop="drop(event)" ondragover="allowDrop(event)" data-type="CHARGE" data-subtype="FINANCE"><div class="block-header"><span>Financi√®res</span></div><div id="zone-charge-finance" class="min-h-[40px] space-y-1 mt-2"></div><div class="zone-total" id="total-charge-finance">0 ‚Ç¨</div></div>
                                    <div class="drop-zone p-2 rounded min-h-[80px]" ondrop="drop(event)" ondragover="allowDrop(event)" data-type="CHARGE" data-subtype="EXCEP"><div class="block-header"><span>Exceptionnelles</span></div><div id="zone-charge-excep" class="min-h-[40px] space-y-1 mt-2"></div><div class="zone-total" id="total-charge-excep">0 ‚Ç¨</div></div>
                                </div>
                            </div>
                            <div class="ledger-container">
                                <div class="bg-gray-200 p-2 font-bold text-center border-b-2 border-gray-900 flex justify-between items-center"><span>PRODUITS</span><span class="text-xs bg-gray-900 text-white px-2 rounded">Cl. 7</span></div>
                                <div class="p-3 space-y-3">
                                    <div class="drop-zone p-2 rounded min-h-[80px]" ondrop="drop(event)" ondragover="allowDrop(event)" data-type="PRODUIT" data-subtype="EXPLOIT"><div class="block-header"><span>Exploitation</span></div><div id="zone-produit-exploit" class="min-h-[40px] space-y-1 mt-2"></div><div class="zone-total" id="total-produit-exploit">0 ‚Ç¨</div></div>
                                    <div class="drop-zone p-2 rounded min-h-[80px]" ondrop="drop(event)" ondragover="allowDrop(event)" data-type="PRODUIT" data-subtype="FINANCE"><div class="block-header"><span>Financiers</span></div><div id="zone-produit-finance" class="min-h-[40px] space-y-1 mt-2"></div><div class="zone-total" id="total-produit-finance">0 ‚Ç¨</div></div>
                                    <div class="drop-zone p-2 rounded min-h-[80px]" ondrop="drop(event)" ondragover="allowDrop(event)" data-type="PRODUIT" data-subtype="EXCEP"><div class="block-header"><span>Exceptionnels</span></div><div id="zone-produit-excep" class="min-h-[40px] space-y-1 mt-2"></div><div class="zone-total" id="total-produit-excep">0 ‚Ç¨</div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-black text-2xl italic uppercase border-l-8 border-blue-500 pl-3 mb-4">II. Bilan</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="ledger-container border-blue-900">
                                <div class="bg-blue-100 p-2 font-bold text-center border-b-2 border-blue-900 text-blue-900">ACTIF</div>
                                <div class="p-3 space-y-3">
                                    <div class="drop-zone p-2 rounded min-h-[100px]" ondrop="drop(event)" ondragover="allowDrop(event)" data-type="ACTIF" data-subtype="IMMO"><div class="block-header bg-blue-900"><span>Immobilis√©</span></div><div id="zone-actif-immo" class="min-h-[60px] space-y-1 mt-2"></div><div class="zone-total" id="total-actif-immo">0 ‚Ç¨</div></div>
                                    <div class="drop-zone p-2 rounded min-h-[100px]" ondrop="drop(event)" ondragover="allowDrop(event)" data-type="ACTIF" data-subtype="CIRC"><div class="block-header bg-blue-800"><span>Circulant</span></div><div id="zone-actif-circ" class="min-h-[60px] space-y-1 mt-2"></div><div class="zone-total" id="total-actif-circ">0 ‚Ç¨</div></div>
                                </div>
                                <div class="bg-blue-50 p-2 text-right font-black font-mono-code text-blue-900 border-t-2 border-blue-900">TOTAL ACTIF: <span id="grand-total-actif">0 ‚Ç¨</span></div>
                            </div>
                            <div class="ledger-container border-red-900">
                                <div class="bg-red-100 p-2 font-bold text-center border-b-2 border-red-900 text-red-900">PASSIF</div>
                                <div class="p-3 space-y-3">
                                    <div class="drop-zone p-2 rounded min-h-[100px]" ondrop="drop(event)" ondragover="allowDrop(event)" data-type="PASSIF" data-subtype="CAPITAUX"><div class="block-header bg-red-900"><span>Capitaux Propres</span></div><div id="zone-passif-capitaux" class="min-h-[60px] space-y-1 mt-2"></div><div class="zone-total" id="total-passif-capitaux">0 ‚Ç¨</div></div>
                                    <div class="drop-zone p-2 rounded min-h-[100px]" ondrop="drop(event)" ondragover="allowDrop(event)" data-type="PASSIF" data-subtype="DETTES"><div class="block-header bg-red-800"><span>Dettes</span></div><div id="zone-passif-dettes" class="min-h-[60px] space-y-1 mt-2"></div><div class="zone-total" id="total-passif-dettes">0 ‚Ç¨</div></div>
                                </div>
                                <div class="bg-red-50 p-2 text-right font-black font-mono-code text-red-900 border-t-2 border-red-900">TOTAL PASSIF: <span id="grand-total-passif">0 ‚Ç¨</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="chapter-2" class="hidden">
            <h2 class="text-3xl font-black font-serif-header mb-8 text-center">L'Organigramme des SIG</h2>
            
            <div class="max-w-3xl mx-auto mb-16 relative flex flex-col items-center">
                <div class="grid grid-cols-2 gap-6 w-full mb-2">
                    <div class="sig-box sig-box-green" onclick="toggleSigInfo(this)"><span class="sig-box-title">MARGE COMMERCIALE</span><div class="sig-bubble">Ventes - Co√ªt d'achat (avec variation stock).</div></div>
                    <div class="sig-box sig-box-green" onclick="toggleSigInfo(this)"><span class="sig-box-title">PRODUCTION</span><div class="sig-bubble" style="left:auto; right:105%;">Vendue + Stock√©e + Immobilis√©e.</div></div>
                </div>
                <div class="line-down"></div>
                <div class="sig-box sig-box-gray w-2/3" onclick="toggleSigInfo(this)">- Conso Tiers<div class="sig-bubble">Achats MP + Services ext√©rieurs.</div></div>
                <div class="arrow-down"></div>
                <div class="sig-box sig-box-green w-2/3" onclick="toggleSigInfo(this)"><span class="sig-box-title">VALEUR AJOUT√âE</span><div class="sig-bubble">Richesse brute cr√©√©e.</div></div>
                <div class="line-down"></div>
                <div class="sig-box sig-box-gray w-2/3" onclick="toggleSigInfo(this)">+ Subv - Imp√¥ts - Personnel<div class="sig-bubble">Partage avec l'√âtat et les salari√©s.</div></div>
                <div class="arrow-down"></div>
                <div class="sig-box sig-box-green w-2/3" onclick="toggleSigInfo(this)"><span class="sig-box-title">EBE</span><div class="sig-bubble">Cash-flow op√©rationnel pur.</div></div>
                <div class="line-down"></div>
                <div class="sig-box sig-box-gray w-2/3" onclick="toggleSigInfo(this)">- DAP + RAP<div class="sig-bubble">Prise en compte de l'usure (amortissements).</div></div>
                <div class="arrow-down"></div>
                <div class="sig-box sig-box-green w-2/3" onclick="toggleSigInfo(this)"><span class="sig-box-title">REX</span><div class="sig-bubble">R√©sultat d'exploitation.</div></div>
                <div class="line-down"></div>
                <div class="sig-box sig-box-gray w-2/3" onclick="toggleSigInfo(this)">+/- Financier<div class="sig-bubble">Int√©r√™ts emprunts vs Placements.</div></div>
                <div class="arrow-down"></div>
                <div class="sig-box sig-box-green w-2/3" onclick="toggleSigInfo(this)"><span class="sig-box-title">RCAI</span><div class="sig-bubble">R√©sultat Courant Avant Imp√¥t.</div></div>
                <div class="line-down"></div>
                <div class="sig-box sig-box-gray w-2/3" onclick="toggleSigInfo(this)">+/- Exceptionnel - IS<div class="sig-bubble">√âl√©ments rares et Imp√¥t Soci√©t√©.</div></div>
                <div class="arrow-down"></div>
                <div class="sig-box sig-box-green w-3/4 border-4" style="transform: scale(1.1); background-color: #ccff00;"><span class="sig-box-title text-xl">R√âSULTAT NET</span></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-gray-100 p-6 border-2 border-gray-400 rounded">
                    <div class="flex justify-between items-center mb-4"><h3 class="font-bold font-mono-code">DONN√âES (Extrait CDR)</h3><button onclick="initSIGGame()" class="action-btn text-xs">‚Üª Nouveau</button></div>
                    <div id="sig-source-data" class="space-y-2 text-sm font-mono-code bg-white p-4 border-2 border-gray-900 shadow-sm"></div>
                </div>
                <div class="bg-white p-6 border-4 border-gray-900 shadow-[8px_8px_0px_0px_#ccff00]">
                    <div class="space-y-3 font-mono-code text-sm">
                        <div class="flex justify-between"><label>1. Marge Co</label><div class="flex gap-2"><input type="number" id="inp-marge" class="hardcore-input">‚Ç¨</div></div>
                        <div class="flex justify-between"><label>2. Production</label><div class="flex gap-2"><input type="number" id="inp-prod" class="hardcore-input">‚Ç¨</div></div>
                        <div class="flex justify-between font-bold"><label>3. VA</label><div class="flex gap-2"><input type="number" id="inp-va" class="hardcore-input">‚Ç¨</div></div>
                        <div class="flex justify-between font-bold"><label>4. EBE</label><div class="flex gap-2"><input type="number" id="inp-ebe" class="hardcore-input">‚Ç¨</div></div>
                        <div class="flex justify-between"><label>5. REX</label><div class="flex gap-2"><input type="number" id="inp-rex" class="hardcore-input">‚Ç¨</div></div>
                        <div class="flex justify-between"><label>6. RCAI</label><div class="flex gap-2"><input type="number" id="inp-rcai" class="hardcore-input">‚Ç¨</div></div>
                        <div class="flex justify-between mt-2 bg-gray-100 p-2"><label class="font-black">7. R√âSULTAT NET</label><div class="flex gap-2"><input type="number" id="inp-rn" class="hardcore-input bg-white border-b-4 border-gray-900">‚Ç¨</div></div>
                    </div>
                    <button onclick="validateSIG()" class="w-full mt-6 py-3 bg-gray-900 text-[#ccff00] font-bold uppercase transition-colors hover:bg-white hover:text-gray-900 border-2 border-gray-900">V√©rifier</button>
                    <div id="sig-feedback" class="mt-4 text-center font-bold hidden font-mono-code"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="footer-chap1" class="sig-panel fixed bottom-0 left-0 w-full px-4 py-3 flex flex-col md:flex-row justify-between items-center gap-4 text-sm md:text-base">
        <div class="flex flex-wrap gap-6 items-center justify-center md:justify-start">
            <div class="flex flex-col"><span class="text-[0.65rem] uppercase text-gray-400">R√©sultat Net</span><span id="sig-res-net" class="sig-value font-bold text-xl text-white">0 ‚Ç¨</span></div>
            <div class="w-px h-8 bg-gray-700 hidden md:block"></div>
            <div class="flex flex-col"><span class="text-[0.65rem] uppercase text-gray-400">√âquilibre</span><span id="bilan-check" class="font-bold text-lg text-red-500">NON</span></div>
        </div>
        <div class="flex gap-4">
            <button onclick="exportToTXT()" class="px-6 py-3 bg-gray-700 text-white font-bold uppercase tracking-widest hover:bg-gray-600 transition-colors shadow-lg cursor-pointer rounded-sm flex items-center gap-2 text-xs md:text-sm">üìÅ Exporter</button>
            <button id="validate-btn" onclick="validate()" class="px-8 py-3 bg-[#ccff00] text-gray-900 font-black uppercase tracking-widest hover:bg-white transition-colors shadow-lg cursor-pointer rounded-sm">V√©rifier</button>
        </div>
    </div>

    <script>
        function dragElement(elmnt) {
            var pos1=0, pos2=0, pos3=0, pos4=0;
            if(document.getElementById(elmnt.id + "-header")) document.getElementById(elmnt.id + "-header").onmousedown = dragMouseDown;
            else elmnt.onmousedown = dragMouseDown;
            function dragMouseDown(e) { e=e||window.event; e.preventDefault(); pos3=e.clientX; pos4=e.clientY; document.onmouseup=closeDragElement; document.onmousemove=elementDrag; }
            function elementDrag(e) { e=e||window.event; e.preventDefault(); pos1=pos3-e.clientX; pos2=pos4-e.clientY; pos3=e.clientX; pos4=e.clientY; elmnt.style.top=(elmnt.offsetTop-pos2)+"px"; elmnt.style.left=(elmnt.offsetLeft-pos1)+"px"; }
            function closeDragElement() { document.onmouseup=null; document.onmousemove=null; }
        }
        dragElement(document.getElementById("calc-window"));

        function toggleCalc() { const w=document.getElementById('calc-window'); w.style.display = (w.style.display==='block') ? 'none' : 'block'; }
        function calcAppend(v) { document.getElementById('calc-display').value += v; }
        function calcClear() { document.getElementById('calc-display').value = ''; }
        function calcResult() { try { const r=Function('"use strict";return ('+document.getElementById('calc-display').value+')')(); document.getElementById('calc-display').value=r; } catch(e){ document.getElementById('calc-display').value='Err'; } }

        let currentChapter=1, currentDifficulty='EASY', currentCompanyName="", journalEntries=[], gameItems=[], sigSolution={};
        const winners = [{ name: "Napol√©on", img: "https://preview.redd.it/v1dgm9hm3sp91.png?auto=webp&s=d7a42b8398951654be0ae5c87f6fecf478c86044", quote: "Impossible n'est pas comptable." }, { name: "Ichiban Kasuga", img: "https://gamejolt.com/p/portrait-of-ichiban-kasuga-wearing-yellow-headphones-for-an-art-com-f4dyrphy", quote: "Critique Hit sur le Bilan !" }, { name: "Neymar JR", img: "https://www.pixelart.name/wp-content/uploads/2024/01/pixelart_name_footballer_neymar_difficult.png", quote: "GOOOOOAL !" }, { name: "Michel Houellebecq", img: "https://image.noelshack.com/fichiers/2025/49/5/1764928236-houellbcq.png", quote: "La seule v√©rit√© tangible." }];
        const prefixes = ["Boulangerie", "Garage", "Start-up", "Cabinet", "Boucherie", "Agence", "Pizzeria", "Cr√®che", "Pharmacie", "EHPAD"]; const suffixes = ["'Chez D√©d√©'", "'Le Gouffre'", "'L'Optimiste'", "'Dernier Recours'", "'Le Blanchisseur'", "'Au Bonheur'"];
        const TYPES = { CHARGE: 'CHARGE', PRODUIT: 'PRODUIT', ACTIF: 'ACTIF', PASSIF: 'PASSIF' };
        const SUBS = { EXPLOIT: 'EXPLOIT', FINANCE: 'FINANCE', EXCEP: 'EXCEP', IMMO: 'IMMO', CIRC: 'CIRC', CAPITAUX: 'CAPITAUX', DETTES: 'DETTES' };
        const DATABASE_FULL = [
            { label: "Achats de marchandises", type: TYPES.CHARGE, sub: SUBS.EXPLOIT, code: '607' }, { label: "Variation de stocks (stockage)", type: TYPES.CHARGE, sub: SUBS.EXPLOIT, code: '603' }, { label: "Imp√¥ts, taxes et versements", type: TYPES.CHARGE, sub: SUBS.EXPLOIT, code: '63' }, { label: "Salaires et traitements", type: TYPES.CHARGE, sub: SUBS.EXPLOIT, code: '641' }, { label: "Charges sociales", type: TYPES.CHARGE, sub: SUBS.EXPLOIT, code: '645' }, { label: "Dotations aux amortissements", type: TYPES.CHARGE, sub: SUBS.EXPLOIT, code: '681' }, { label: "Int√©r√™ts pay√©s", type: TYPES.CHARGE, sub: SUBS.FINANCE, code: '66' }, { label: "Produits des participations", type: TYPES.PRODUIT, sub: SUBS.FINANCE, code: '76' }, { label: "Ventes de marchandises (CA)", type: TYPES.PRODUIT, sub: SUBS.EXPLOIT, code: '707' }, { label: "Redevances (brevets, licences)", type: TYPES.PRODUIT, sub: SUBS.EXPLOIT, code: '751' }, { label: "Quotes-parts de r√©sultat", type: TYPES.PRODUIT, sub: SUBS.EXPLOIT, code: '755' }, { label: "Subventions d'exploitation", type: TYPES.PRODUIT, sub: SUBS.EXPLOIT, code: '74' }, { label: "Produits exceptionnels", type: TYPES.PRODUIT, sub: SUBS.EXCEP, code: '771' }, { label: "Charges exceptionnelles", type: TYPES.CHARGE, sub: SUBS.EXCEP, code: '671' }, { label: "Int√©r√™ts re√ßus", type: TYPES.PRODUIT, sub: SUBS.FINANCE, code: '76' }, { label: "Dotations aux provisions", type: TYPES.CHARGE, sub: SUBS.EXPLOIT, code: '681' }, { label: "Autres charges d'exploitation", type: TYPES.CHARGE, sub: SUBS.EXPLOIT, code: '65' }, { label: "Reprises sur amortissements", type: TYPES.PRODUIT, sub: SUBS.EXPLOIT, code: '78' }, { label: "Val. Comptable Elts C√©d√©s (VCEAC)", type: TYPES.CHARGE, sub: SUBS.EXCEP, code: '675' }, { label: "Prod. Cession Elts Actif (PCEA)", type: TYPES.PRODUIT, sub: SUBS.EXCEP, code: '775' }, { label: "Capital Social", type: TYPES.PASSIF, sub: SUBS.CAPITAUX, code: '101' }, { label: "Emprunts Bancaires", type: TYPES.PASSIF, sub: SUBS.DETTES, code: '164' }, { label: "Stock Final Marchandises", type: TYPES.ACTIF, sub: SUBS.CIRC, code: '37' }
        ];

        function switchChapter(id) {
            currentChapter = id; document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active')); document.getElementById(`tab-${id}`).classList.add('active');
            if(id===1){ document.getElementById('chapter-1').classList.remove('hidden'); document.getElementById('chapter-2').classList.add('hidden'); document.getElementById('footer-chap1').classList.remove('hidden'); } 
            else { document.getElementById('chapter-1').classList.add('hidden'); document.getElementById('chapter-2').classList.remove('hidden'); document.getElementById('footer-chap1').classList.add('hidden'); initSIGGame(); }
        }
        function toggleSigInfo(el) { const b=el.querySelector('.sig-bubble'); if(b) b.style.display = (b.style.display==='block')?'none':'block'; }
        function initSIGGame() {
            const r = (min, max) => Math.floor(Math.random() * (max - min) + min);
            const d = { ventes: r(20000,50000), achats: r(8000,15000), prod: r(5000,10000), ext: r(3000,5000), pers: r(5000,8000), dap: r(1000,2000), fin: r(500,1000), is: 0 };
            sigSolution = {
                margeCo: d.ventes - d.achats, production: d.prod, va: (d.ventes - d.achats) + d.prod - d.ext,
                ebe: ((d.ventes - d.achats) + d.prod - d.ext) - d.pers, rex: ((d.ventes - d.achats) + d.prod - d.ext) - d.pers - d.dap,
                rcai: (((d.ventes - d.achats) + d.prod - d.ext) - d.pers - d.dap) - d.fin, rn: (((d.ventes - d.achats) + d.prod - d.ext) - d.pers - d.dap) - d.fin
            };
            const html = `<div class="flex justify-between border-b"><span>Ventes Marchandises</span><span>${d.ventes} ‚Ç¨</span></div><div class="flex justify-between border-b"><span>Achats Marchandises</span><span>${d.achats} ‚Ç¨</span></div><div class="flex justify-between border-b"><span>Production Vendue</span><span>${d.prod} ‚Ç¨</span></div><div class="flex justify-between border-b"><span>Services Ext√©rieurs</span><span>${d.ext} ‚Ç¨</span></div><div class="flex justify-between border-b"><span>Charges Personnel</span><span>${d.pers} ‚Ç¨</span></div><div class="flex justify-between border-b"><span>Dotations (DAP)</span><span>${d.dap} ‚Ç¨</span></div><div class="flex justify-between border-b"><span>Charges Financi√®res</span><span>${d.fin} ‚Ç¨</span></div>`;
            document.getElementById('sig-source-data').innerHTML = html;
            document.querySelectorAll('#chapter-2 input').forEach(i => { i.value = ''; i.classList.remove('bg-red-100','bg-green-100')}); document.getElementById('sig-feedback').classList.add('hidden');
        }
        function validateSIG() {
            const inputs = { margeCo: parseInt(document.getElementById('inp-marge').value), production: parseInt(document.getElementById('inp-prod').value), va: parseInt(document.getElementById('inp-va').value), ebe: parseInt(document.getElementById('inp-ebe').value), rex: parseInt(document.getElementById('inp-rex').value), rcai: parseInt(document.getElementById('inp-rcai').value), rn: parseInt(document.getElementById('inp-rn').value) };
            let err = 0; for(let k in inputs) { const el = document.querySelector(`input[id^="inp-${k.substring(0,2)}"]`); if(el) { if(inputs[k] === sigSolution[k]) { el.classList.add('bg-green-100'); el.classList.remove('bg-red-100'); } else { el.classList.add('bg-red-100'); el.classList.remove('bg-green-100'); err++; } } }
            const fb = document.getElementById('sig-feedback'); fb.classList.remove('hidden');
            if(err===0) { fb.innerText="PARFAIT !"; fb.className="mt-4 text-center font-bold text-green-600"; const winner = winners[Math.floor(Math.random() * winners.length)]; document.getElementById('victory-content').innerHTML = `<img src="${winner.img}" alt="${winner.name}" class="w-32 h-32 mx-auto mb-4 border-4 border-gray-900 rounded-full bg-[#ccff00] pixelated-img object-cover"><h2 class="text-4xl font-black font-mono-code uppercase text-[#dc2626] leading-tight mb-2 transform -rotate-2">${winner.name}</h2><p class="font-serif-header italic text-gray-600 text-sm mt-4">"${winner.quote}"</p>`; document.getElementById('victory-modal').classList.remove('hidden'); } else { fb.innerText=`${err} Erreurs`; fb.className="mt-4 text-center font-bold text-red-600"; }
        }
        function openTuto() { document.getElementById('tuto-modal').classList.remove('hidden'); }
        function closeTuto() { document.getElementById('tuto-modal').classList.add('hidden'); }
        function closeModal() { document.getElementById('victory-modal').classList.add('hidden'); }
        
        function setDifficulty(mode) {
            currentDifficulty = mode; document.querySelectorAll('.diff-btn').forEach(btn => btn.classList.remove('active')); document.getElementById(`btn-${mode.toLowerCase()}`).classList.add('active');
            const journal = document.getElementById('journal-panel'); const slider = document.getElementById('duration-control');
            if(mode === 'HARDCORE') { journal.classList.remove('hidden'); slider.classList.remove('hidden'); } else { journal.classList.add('hidden'); slider.classList.add('hidden'); }
            initGame();
        }
        function initGame() {
            currentCompanyName = `${prefixes[Math.floor(Math.random()*prefixes.length)]} ${suffixes[Math.floor(Math.random()*suffixes.length)]}`;
            document.getElementById('company-name').innerText = currentCompanyName;
            closeModal(); journalEntries = [];
            document.querySelectorAll('.drop-zone div[id^="zone-"]').forEach(z => z.innerHTML = '');
            document.getElementById('source-zone').innerHTML = ''; document.getElementById('journal-content').innerHTML = '';
            const btn = document.getElementById('validate-btn'); btn.innerText = "V√©rifier"; btn.classList.replace('bg-white', 'bg-[#ccff00]');
            // RESTORED LOGIC FROM V19
            if(currentDifficulty === 'HARDCORE') initHardcoreMode(); else initStandardMode();
        }

        // --- GAME ENGINES (RESTORED) ---
        function initStandardMode() {
            gameItems = []; const selection = [...DATABASE_FULL].sort(() => 0.5 - Math.random()).slice(0, 12); let tC=0, tP=0, tA=0, tPas=0;
            selection.forEach((op, i) => { const amount = Math.floor(Math.random()*4000)+100; gameItems.push({...op, id:`op-${i}`, amount}); if(op.type===TYPES.CHARGE) tC+=amount; if(op.type===TYPES.PRODUIT) tP+=amount; if(op.type===TYPES.ACTIF) tA+=amount; if(op.type===TYPES.PASSIF) tPas+=amount; });
            const res = tP - tC; gameItems.push({ id:'op-res', label:"R√©sultat Net", type:TYPES.PASSIF, sub:SUBS.CAPITAUX, code:'120', amount:res }); tPas += res;
            const bank = tPas - tA; if(bank>=0) gameItems.push({id:'op-bank', label:"Banque (Solde)", type:TYPES.ACTIF, sub:SUBS.CIRC, code:'512', amount:bank}); else gameItems.push({id:'op-bank', label:"D√©couvert", type:TYPES.PASSIF, sub:SUBS.DETTES, code:'512', amount:Math.abs(bank)});
            renderCards(); updateCalculations();
        }
        function initHardcoreMode() {
            gameItems = []; const journalDiv = document.getElementById('journal-content'); const ledger = {}; const durationMul = parseInt(document.getElementById('game-duration').value);
            let currentSupplierDebt=0, currentCustomerReceivable=0;
            const impact = (label, type, sub, code, amount, isDebit) => { const key = code; if(!ledger[key]) ledger[key]={label, type, sub, code, balance:0}; if(type===TYPES.ACTIF || type===TYPES.CHARGE) ledger[key].balance+=isDebit?amount:-amount; else ledger[key].balance+=isDebit?-amount:amount; };
            const addEntry = (date, text) => { journalEntries.push(`${date} : ${text}`); const p=document.createElement('p'); p.innerHTML=`<strong>${date}</strong> : ${text}`; p.className="border-b border-blue-200 pb-1"; journalDiv.appendChild(p); };
            let currentDate=new Date(2024,0,1); const nextDate=()=>{currentDate.setDate(currentDate.getDate()+Math.floor(Math.random()*5)+2); return currentDate.toLocaleDateString('fr-FR');};
            const capital=30000; impact("Capital Social", TYPES.PASSIF, SUBS.CAPITAUX, '101', capital, false); impact("Banque", TYPES.ACTIF, SUBS.CIRC, '512', capital, true); addEntry("01/01/2024", `Capital social : ${capital}‚Ç¨.`);
            const loops=4*durationMul; 
            for(let i=0; i<loops; i++) {
                const rand=Math.random();
                if(rand<0.15){ const v=2000,p=2500; impact("Val. Comptable Elts C√©d√©s", TYPES.CHARGE, SUBS.EXCEP, '675', v, true); impact("Prod. Cession Elts Actif", TYPES.PRODUIT, SUBS.EXCEP, '775', p, false); impact("Banque", TYPES.ACTIF, SUBS.CIRC, '512', p, true); addEntry(nextDate(), `Cession actif (VNC:${v}‚Ç¨) pour ${p}‚Ç¨.`); }
                else if(rand<0.25){ const s=1000; impact("Subventions d'exploitation", TYPES.PRODUIT, SUBS.EXPLOIT, '74', s, false); impact("Banque", TYPES.ACTIF, SUBS.CIRC, '512', s, true); addEntry(nextDate(), `Subvention re√ßue : ${s}‚Ç¨.`); }
                else if(rand<0.7){ const a=1000+Math.floor(Math.random()*2000); if(Math.random()>0.5){ impact("Achats de marchandises", TYPES.CHARGE, SUBS.EXPLOIT, '607', a, true); impact("Dettes Fournisseurs", TYPES.PASSIF, SUBS.DETTES, '401', a, false); currentSupplierDebt+=a; addEntry(nextDate(), `Achat marchandise cr√©dit : ${a}‚Ç¨.`); } else { impact("Ventes de marchandises", TYPES.PRODUIT, SUBS.EXPLOIT, '707', a, false); impact("Banque", TYPES.ACTIF, SUBS.CIRC, '512', a, true); addEntry(nextDate(), `Vente comptant : ${a}‚Ç¨.`); } }
            }
            impact("Salaires et traitements", TYPES.CHARGE, SUBS.EXPLOIT, '641', 3000, true); impact("Banque", TYPES.ACTIF, SUBS.CIRC, '512', 3000, false); addEntry(nextDate(), "Salaires : 3000‚Ç¨.");
            const stock=5000; impact("Stock Final Marchandises", TYPES.ACTIF, SUBS.CIRC, '37', stock, true); impact("Variation de stocks (stockage)", TYPES.CHARGE, SUBS.EXPLOIT, '603', stock, false); addEntry("31/12/2024", `Stock final : ${stock}‚Ç¨.`);
            let tC=0, tP=0; Object.values(ledger).forEach(acc=>{if(acc.type===TYPES.CHARGE)tC+=acc.balance;if(acc.type===TYPES.PRODUIT)tP+=acc.balance;});
            ledger['120']={label:"R√©sultat (√† calculer !)", type:TYPES.PASSIF, sub:SUBS.CAPITAUX, code:'120', balance:tP-tC};
            Object.values(ledger).forEach((acc, i)=>{if(Math.abs(acc.balance)>0) gameItems.push({id:`op-${i}`, label:acc.label, type:acc.type, sub:acc.sub, code:acc.code, amount:acc.balance, isHardcore:true});});
            renderCards(); updateCalculations();
        }

        function renderCards() { const z = document.getElementById('source-zone'); gameItems.sort(() => 0.5 - Math.random()).forEach(i => z.appendChild(createCard(i))); }
        function createCard(item) {
            const div = document.createElement('div'); div.id = item.id; div.className = "sketchy-card p-2 cursor-grab animate-pop mb-2 text-sm"; div.draggable = true;
            div.dataset.type = item.type; div.dataset.sub = item.sub; div.dataset.trueAmount = item.amount; div.dataset.currentAmount = currentDifficulty === 'HARDCORE' ? 0 : item.amount; div.dataset.label = item.label;
            let display = (currentDifficulty === 'HARDCORE') ? `<input type="number" class="hardcore-input" placeholder="?" onmousedown="event.stopPropagation()" oninput="updateCardAmount(this)"> ‚Ç¨` : `${item.amount.toLocaleString('fr-FR')} ‚Ç¨`;
            let code = (currentDifficulty === 'EASY') ? `<span class="font-mono-code text-[0.65rem] bg-gray-200 px-1 rounded text-gray-800">${item.code}</span>` : ``;
            div.innerHTML = `<div class="flex justify-between items-start pointer-events-none"><span class="font-bold leading-tight pr-2 text-gray-900">${item.label}</span>${code}</div><div class="mt-1 text-right font-mono-code font-bold text-gray-600">${display}</div>`;
            div.addEventListener('dragstart', (e) => { if(e.target.tagName === 'INPUT') {e.preventDefault(); return;} e.target.classList.remove('valid-success', 'valid-error'); e.dataTransfer.setData("text", e.target.id); setTimeout(() => e.target.classList.add('dragging'), 0); });
            div.addEventListener('dragend', (e) => { e.target.classList.remove('dragging'); updateCalculations(); });
            return div;
        }
        function updateCardAmount(input) { input.closest('.sketchy-card').dataset.currentAmount = parseInt(input.value) || 0; updateCalculations(); }
        function allowDrop(ev) { ev.preventDefault(); }
        function drop(ev) {
            ev.preventDefault(); const data = ev.dataTransfer.getData("text"); const el = document.getElementById(data); if(!el) return;
            let target = ev.target; while(target && !target.classList.contains('drop-zone') && target.id !== 'source-zone') target = target.parentNode; if(!target) return;
            let container = target.classList.contains('drop-zone') ? target.querySelector('div[id^="zone-"]') : target;
            if(container) { container.appendChild(el); el.style.transform = container.id !== 'source-zone' ? `rotate(${Math.random() * 2 - 1}deg)` : 'none'; }
            updateCalculations();
        }
        function updateCalculations() {
            const sum = (id) => { const z = document.getElementById(id); if(!z) return 0; let t = 0; for(let c of z.children) t += parseInt(c.dataset.currentAmount || 0); return t; };
            const m = { 'zone-charge-exploit': 'total-charge-exploit', 'zone-charge-finance': 'total-charge-finance', 'zone-charge-excep': 'total-charge-excep', 'zone-produit-exploit': 'total-produit-exploit', 'zone-produit-finance': 'total-produit-finance', 'zone-produit-excep': 'total-produit-excep', 'zone-actif-immo': 'total-actif-immo', 'zone-actif-circ': 'total-actif-circ', 'zone-passif-capitaux': 'total-passif-capitaux', 'zone-passif-dettes': 'total-passif-dettes' };
            for(const [z, d] of Object.entries(m)) document.getElementById(d).innerText = sum(z).toLocaleString('fr-FR') + ' ‚Ç¨';
            const tA = sum('zone-actif-immo') + sum('zone-actif-circ'); const tP = sum('zone-passif-capitaux') + sum('zone-passif-dettes');
            const charges = sum('zone-charge-exploit') + sum('zone-charge-finance') + sum('zone-charge-excep'); const prods = sum('zone-produit-exploit') + sum('zone-produit-finance') + sum('zone-produit-excep');
            document.getElementById('sig-res-net').innerText = (prods - charges).toLocaleString('fr-FR') + ' ‚Ç¨';
            const check = document.getElementById('bilan-check');
            if(tA > 0 && Math.abs(tA - tP) < 2) { check.innerText = "OUI"; check.className = "font-bold text-lg text-[#ccff00]"; } else { check.innerText = "NON"; check.className = "font-bold text-lg text-red-500"; }
        }
        function validate() {
            let err = 0, total = 0;
            document.querySelectorAll('.drop-zone').forEach(z => {
                const expT = z.dataset.type; const expS = z.dataset.subtype;
                for(let item of z.querySelector('div[id^="zone-"]').children) {
                    total++; let posOk = (item.dataset.type === expT && item.dataset.sub === expS);
                    let valOk = true; if(currentDifficulty === 'HARDCORE') valOk = Math.abs(parseInt(item.dataset.currentAmount)) === Math.abs(parseInt(item.dataset.trueAmount));
                    item.classList.remove('valid-success', 'valid-error'); if(posOk && valOk) item.classList.add('valid-success'); else { item.classList.add('valid-error'); err++; }
                }
            });
            const left = document.getElementById('source-zone').children.length; const bal = document.getElementById('bilan-check').innerText === "OUI"; const btn = document.getElementById('validate-btn');
            if(err === 0 && left === 0 && bal) {
                btn.innerText = "Parfait !";
                const winner = winners[Math.floor(Math.random() * winners.length)];
                document.getElementById('victory-content').innerHTML = `<img src="${winner.img}" alt="${winner.name}" class="w-32 h-32 mx-auto mb-4 border-4 border-gray-900 rounded-full bg-[#ccff00] pixelated-img object-cover"><h2 class="text-4xl font-black font-mono-code uppercase text-[#dc2626] leading-tight mb-2 transform -rotate-2">${winner.name}</h2><p class="font-serif-header italic text-gray-600 text-sm mt-4">"${winner.quote}"</p>`;
                document.getElementById('victory-modal').classList.remove('hidden');
            } else { btn.innerText = `${err} Erreurs / ${left} Restants`; setTimeout(() => btn.innerText = "V√©rifier", 2000); }
        }
        function exportToTXT() {
            let c = `EXERCICE - ${currentCompanyName}\nDIFFICULTE: ${currentDifficulty}\n\n=== JOURNAL ===\n${journalEntries.join('\n')}\n\n=== REPONSES ===\n`;
            document.querySelectorAll('.drop-zone, #source-zone').forEach(z => {
                let n = z.id; if(z.dataset.type) n = `${z.dataset.type}-${z.dataset.subtype}`;
                const cont = z.querySelector('div[id^="zone-"]') || z;
                for(let i of cont.children) c += `ZONE: ${n} | CARTE: ${i.dataset.label} | SAISIE: ${i.dataset.currentAmount} | ATTENDU: ${i.dataset.trueAmount}\n`;
            });
            const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([c], { type: "text/plain" })); a.download = `compta_export.txt`; a.click();
        }
        function closeModal() { document.getElementById('victory-modal').classList.add('hidden'); }
        window.addEventListener('DOMContentLoaded', () => { if(!localStorage.getItem('tutoSeenV25')) { openTuto(); localStorage.setItem('tutoSeenV25', 'true'); } initGame(); });
    </script>
</body>
</html>
